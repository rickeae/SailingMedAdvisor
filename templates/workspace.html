<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Workspace - SailingMedAdvisor</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@500;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Space Grotesk', 'Manrope', 'Inter', system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at 10% 20%, #d7e8ff 0, #f3f7ff 40%, #e7ecf7 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #1f2d3d;
        }
        .shell {
            background: linear-gradient(160deg, #ffffff 0%, #f8fbff 60%, #f1f5ff 100%);
            border-radius: 18px;
            box-shadow: 0 18px 48px rgba(26, 84, 144, 0.16);
            padding: 30px;
            width: min(860px, 100%);
            border: 1px solid #e1e9f7;
            position: relative;
            overflow: hidden;
        }
        .shell::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 120% -20%, rgba(102,126,234,0.15), transparent 50%),
                        radial-gradient(circle at -10% 120%, rgba(118,75,162,0.12), transparent 40%);
            pointer-events: none;
        }
        h1 { font-size: 28px; margin-bottom: 6px; color: #123f77; letter-spacing: -0.3px; }
        h2 { font-size: 20px; margin: 14px 0 6px; color: #1f2d3d; letter-spacing: -0.2px; }
        .lead { color: #42526b; margin-bottom: 18px; line-height: 1.6; font-size: 15px; }
        .banner {
            padding: 18px;
            border-radius: 14px;
            background: linear-gradient(120deg, #0a6ff0 0%, #0b94d9 55%, #0cb8c2 100%);
            color: #f7fbff;
            margin-bottom: 18px;
            box-shadow: 0 10px 28px rgba(12, 136, 213, 0.28);
        }
        .banner h1 { color: #f7fbff; margin: 0 0 8px; font-size: 30px; }
        .banner p { margin: 0; font-size: 14px; opacity: 0.9; }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(255,255,255,0.14);
            color: #e8f5ff;
            font-weight: 700;
            letter-spacing: 0.2px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
            margin: 12px 0 10px;
        }
        .divider {
            height: 1px;
            background: #e4eaf5;
            margin: 12px 0;
            border: none;
        }
        .card {
            border: 1px solid #d9e3f5;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            background: #ffffff;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card input { accent-color: #1a5490; width: 18px; height: 18px; }
        .card:hover { border-color: #b8ccf5; box-shadow: 0 10px 26px rgba(26, 84, 144, 0.12); transform: translateY(-1px); }
        .card.selected { border-color: #1250a5; background: linear-gradient(140deg, #f1f6ff 0%, #e6edff 100%); box-shadow: 0 12px 28px rgba(18, 80, 165, 0.22); }
        .actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 18px; }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #1250a5 0%, #0c8bd1 100%);
            color: #fff;
            box-shadow: 0 12px 26px rgba(18, 80, 165, 0.35);
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        label[for="workspace-password"] { font-weight: 700; color: #1f2d3d; }
        #workspace-password {
            padding: 12px;
            width: 100%;
            border: 1px solid #d7def0;
            border-radius: 10px;
            margin-top: 6px;
            background: #f8faff;
            font-size: 15px;
        }
        .subtle {
            margin-top: 6px;
            font-size: 12px;
            color: #566172;
        }
    </style>
</head>
<body>
    <div class="shell">
        <div class="banner">
            <div class="badge">SailingMedAdvisor Â· Beta Test</div>
            <h1>SailingMedAdvisor Beta Test</h1>
            <p>Thank you for taking a look at the app and providing feedback.</p>
        </div>

        <h2>Choose your workspace</h2>
        <p class="lead">Workspaces keep data, uploads, and history isolated. Pick the one you need, then continue to login.</p>
        <div id="workspace-error" style="display:none; margin-bottom:10px; padding:10px; border-radius:8px; border:1px solid #e53935; background:#ffebee; color:#c62828; font-weight:700;"></div>

        <form method="POST" action="/workspace" id="workspaceForm">
            <div class="grid">
                {% for name in workspaces %}
                <label class="card {% if selected == name %}selected{% endif %}">
                    <input type="radio" name="workspace" value="{{ name }}" {% if selected == name %}checked{% endif %} required>
                    <span>{{ name }}</span>
                </label>
                {% endfor %}
            </div>
            <div style="margin-top:12px;">
                <label for="workspace-password">Workspace Access Password</label>
                <input type="password" id="workspace-password" name="password" placeholder="Enter password" required>
                <div class="subtle">All workspace users must enter the shared password to continue.</div>
            </div>
            <div class="actions">
                <button type="submit" class="btn-primary" id="continueBtn" {% if not selected %}disabled{% endif %}>Continue to Login</button>
            </div>
        </form>
    </div>

    <script>
        const form = document.getElementById('workspaceForm');
        const btn = document.getElementById('continueBtn');
        const pwd = document.getElementById('workspace-password');
        const errBox = document.getElementById('workspace-error');
        form.addEventListener('change', (e) => {
            if (e.target.name === 'workspace') {
                document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
                e.target.closest('.card').classList.add('selected');
                btn.disabled = false;
            }
        });
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errBox.style.display = 'none';
            const selected = form.querySelector('input[name="workspace"]:checked');
            if (!selected) {
                errBox.textContent = 'Please select a workspace.';
                errBox.style.display = 'block';
                return;
            }
            if (!pwd.value) {
                errBox.textContent = 'Please enter the workspace password.';
                errBox.style.display = 'block';
                return;
            }
            btn.disabled = true;
            try {
                const fd = new FormData(form);
                const res = await fetch('/workspace', { method: 'POST', body: fd, credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                if (res.redirected) {
                    window.location = res.url;
                    return;
                }
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.error) {
                    throw new Error(data.error || `Status ${res.status}`);
                }
                try { localStorage.setItem('workspace_label', selected.value); } catch (e) { /* ignore */ }
                await handleWorkspaceAction(selected.value);
            } catch (err) {
                errBox.textContent = err.message || 'Unable to set workspace.';
                errBox.style.display = 'block';
                btn.disabled = false;
            }
        });

        function buildActionModal(workspaceName) {
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.background = 'rgba(0,0,0,0.35)';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '9999';

            const box = document.createElement('div');
            box.style.background = '#fff';
            box.style.padding = '20px';
            box.style.borderRadius = '10px';
            box.style.width = '400px';
            box.style.maxWidth = '90vw';
            box.style.boxShadow = '0 8px 30px rgba(0,0,0,0.2)';

            box.innerHTML = `
                <div style="font-weight:800; color:#1f2d3d; font-size:16px; margin-bottom:8px;">Workspace Ready</div>
                <div style="font-size:13px; color:#37474f; margin-bottom:14px;">You selected <b>${workspaceName}</b>. Choose what to do with your data:</div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button id="ws-keep" class="btn-primary" style="background:#2e7d32;">Leave data unchanged</button>
                    <button id="ws-sample" class="btn-primary" style="background:#1565c0;">Replace all data with sample data</button>
                    <button id="ws-clear" class="btn-primary" style="background:#c62828;">Clear all data and start from scratch</button>
                </div>
            `;
            overlay.appendChild(box);
            document.body.appendChild(overlay);
            return overlay;
        }

        async function handleWorkspaceAction(workspaceName) {
            btn.disabled = false;
            const modal = buildActionModal(workspaceName);
            const closeAndGo = (url) => {
                modal.remove();
                window.location.href = url;
            };
            modal.querySelector('#ws-clear').onclick = async () => {
                const confirmed = confirm('Are you sure you want to CLEAR all data in this workspace? This cannot be undone.');
                if (!confirmed) return;
                try {
                    const res = await fetch('/api/workspace/reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ action: 'clear' })
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok || data.error) throw new Error(data.error || `Status ${res.status}`);
                    alert('Workspace data cleared.');
                } catch (err) {
                    alert(`Unable to clear workspace: ${err.message}`);
                } finally {
                    closeAndGo('/login');
                }
            };
            modal.querySelector('#ws-sample').onclick = async () => {
                try {
                    const res = await fetch('/api/workspace/reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ action: 'sample' })
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok || data.error) throw new Error(data.error || `Status ${res.status}`);
                    alert('Workspace ready for sample data. (Awaiting provided files.)');
                } catch (err) {
                    alert(`Unable to mark workspace for sample data: ${err.message}`);
                } finally {
                    closeAndGo('/login');
                }
            };
            modal.querySelector('#ws-keep').onclick = async () => {
                try {
                    await fetch('/api/workspace/reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ action: 'keep' })
                    });
                } catch (err) { /* no-op */ }
                closeAndGo('/login');
            };
        }
    </script>
</body>
</html>
