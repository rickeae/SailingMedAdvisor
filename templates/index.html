<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MedGemma Master v5.7</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --page-width: 1100px; --banner-height: 60px; --green: #2e7d32; --blue: #1565c0; --red: #c62828; --dark: #2c3e50; --bg: #f4f7f6; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .nav { background: var(--dark); display: flex; padding: 0 12px; min-height: var(--banner-height); align-items: center; flex-shrink: 0; max-width: var(--page-width); width: 100%; margin: 0 auto; box-sizing: border-box; gap: 8px; }
        .page-shell { max-width: var(--page-width); margin: 0 auto; width: 100%; box-sizing: border-box; }
        .tab { color: white; background: none; border: none; padding: 10px 15px; cursor: pointer; font-weight: 700; flex: 1; text-align: center; }
        .tab.active { color: #ffd54f; background: var(--green); border-radius: 4px; }
        .tab-triage { flex: 1.2; font-weight: 900; }
        .tab-nowrap { white-space: nowrap; }
        .tab-config { color: white; }
        .content { flex-grow: 1; padding: 15px; overflow-y: auto; display: none; flex-direction: column; }
        
        .banner { padding: 12px 20px; color: white; font-weight: 900; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; border-radius: 0; background: var(--green); transition: 0.3s; max-width: var(--page-width); margin: 0 auto; box-sizing: border-box; min-height: var(--banner-height); }
        .banner-controls { display: none; align-items: center; gap: 10px; flex: 1; min-width: 320px; flex-wrap: wrap; }
        .banner-controls select { padding: 10px; font-weight: bold; }
        .banner-controls button { height: 44px; }
        .banner-label { font-weight: 700; }
        .mode-toggle { padding: 10px 16px; font-weight: 800; color: var(--dark); border: 1px solid #ccc; border-radius: 6px; cursor: pointer; min-width: 140px; background: white; }
        .banner.inquiry-mode { background: var(--blue); }
        .banner.private-mode { background: var(--red) !important; box-shadow: 0 0 15px var(--red); }

        .triage-wrapper { max-width: var(--page-width); margin: 0 auto; border: 1px solid #ddd; border-top: none; display: flex; flex-direction: column; flex: 1; width: 100%; }
        .chat-area { background: white; border-radius: 0; border: none; display: flex; flex-direction: column; flex: 1; min-height: 0; width: 100%; }
        .chat-area > div { width: 100%; box-sizing: border-box; }
        .display { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .response-block { border-left: 6px solid var(--green); padding: 15px; margin: 15px 0; background: #f9f9f9; }
        .history-list { display: flex; flex-direction: column; gap: 8px; }
        .history-item { border: 1px solid #ddd; border-radius: 6px; background: #fff; }
        .history-header { padding: 6px 10px; display: flex; align-items: center; cursor: pointer; font-weight: bold; gap: 10px; min-height: 38px; }
        .history-body { padding: 10px 12px; border-top: 1px solid #eee; display: none; }
        .history-wrapper { max-width: var(--page-width); width: 100%; margin: 0 auto; border: 1px solid #ddd; background: #fff; padding: 15px; box-sizing: border-box; }
        .panel-wrapper { max-width: var(--page-width); width: 100%; margin: 0 auto; border: 1px solid #ddd; background: #fff; padding: 15px; box-sizing: border-box; }
        .history-response { margin: 0; }
        .history-action-btn { min-width: 90px; visibility: hidden; justify-content: center; }
        .history-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-arrow { font-size: 18px; width: 18px; text-align: center; }
        .crew-med-header { padding: 6px 10px !important; min-height: 38px; display: flex; align-items: center; gap: 10px; }

        .collapsible { background: white; border: 1px solid #ddd; margin-bottom: 4px; border-radius: 4px; }
        .col-header { padding: 8px 12px; cursor: pointer; background: #f8f9fa; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
        .col-body { padding: 12px; display: none; }
        .compact-textarea { height: 80px; font-size: 13px; }
        .btn-row { display: flex; gap: 8px; margin-top: 10px; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .crew-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .btn { padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .config-card { background: white; padding: 25px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; color: var(--dark); }
        textarea { width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-sizing: border-box; font-family: inherit; }
        
        .loading-indicator { color: #666; font-style: italic; padding: 10px; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="nav">
    <button class="tab tab-triage active" onclick="showTab(event, 'Chat')">TRIAGE CHAT</button>
    <button class="tab" onclick="showTab(event, 'ChatHistory')">CHAT HISTORY</button>
    <button class="tab tab-nowrap" onclick="showTab(event, 'CrewMedical')">CREW MEDICALS</button>
    <button class="tab" onclick="showTab(event, 'OnboardPharmacy')">PHARMACY</button>
    <button class="tab" onclick="showTab(event, 'OnboardEquipment')">EQUIPMENT</button>
    <button class="tab" onclick="showTab(event, 'VesselCrewInfo')">VESSEL & CREW</button>
    <button class="tab tab-config" onclick="showTab(event, 'Settings')">SETTINGS</button>
</div>

<div class="page-shell">
    <div id="banner" class="banner">
        <div id="banner-controls-triage" class="banner-controls" style="display:flex;">
            <button id="mode-toggle" class="mode-toggle" onclick="toggleMode()">TRIAGE CHAT</button>
            <select id="p-select" style="flex:1;"></select>
            <select id="model-select" style="min-width:200px;"><option value="google/medgemma-1.5-4b-it">medgemma-1.5-4b-it</option><option value="google/medgemma-1.5-28b-it">medgemma-1.5-28b-it</option></select>
            <button onclick="togglePriv()" id="priv-btn" class="btn" style="background:#555;">PRIVACY: OFF</button>
        </div>
        <div id="banner-controls-history" class="banner-controls" style="display:none; gap:10px; flex-wrap:wrap;">
            <select id="history-sort" onchange="loadHistory()" style="padding:8px; font-weight:bold;">
                <option value="date">Sort: Date/Time</option>
                <option value="first">Sort: First Name</option>
                <option value="last">Sort: Last Name</option>
                <option value="query">Sort: Query Text</option>
            </select>
            <input id="history-search" type="text" placeholder="Search history..." style="padding:8px; flex:1; min-width:200px;" onkeydown="if(event.key==='Enter') loadHistory();">
            <button onclick="loadHistory()" class="btn btn-sm" style="background:var(--blue);">Search</button>
            <button onclick="resetHistorySearch()" class="btn btn-sm" style="background:#555;">Show All</button>
        </div>
        <div id="banner-controls-crew" class="banner-controls" style="justify-content:space-between; gap:12px;">
            <div style="display:flex; gap:12px; align-items:center; flex:1;">
                <select id="crew-sort" onchange="loadData()" style="padding:10px; font-size:13px;">
                <option value="last">Sort: Last Name</option>
                <option value="first">Sort: First Name</option>
                <option value="birthdate-asc">Sort: Birthdate (Youngest First)</option>
                <option value="birthdate-desc">Sort: Birthdate (Oldest First)</option>
            </select>
                <button id="crew-med-export-all-btn" onclick="exportAllMedical()" class="btn btn-sm" style="background:var(--blue); display:none;">ðŸ“¤ Export All Medical</button>
            </div>
            <button id="crew-csv-btn" onclick="exportCrewList()" class="btn btn-sm" style="background:var(--blue); display:none; align-self:center;">ðŸ“‹ Crew List CSV</button>
        </div>
    </div>
</div>

<div id="Chat" class="content" style="display:flex;">
    <div class="triage-wrapper">
        <div class="chat-area">
        <div id="display" class="display"></div>
        <div style="padding:20px; background:#f4f4f4;">
            <textarea id="msg" style="height:70px;" placeholder="Clinical notes... (Enter to submit, Shift+Enter for new line)"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="runChat()" id="run-btn" class="btn" style="flex-grow:1; background:var(--green);">RUN ANALYSIS</button>
                <button onclick="repeatLast()" id="repeat-btn" class="btn" style="background:#555;">REPEAT LAST</button>
            </div>
            </div>
        </div>
    </div>
</div>

<div id="ChatHistory" class="content">
    <div class="page-shell">
        <div class="history-wrapper">
            <div id="history-list" class="history-list"></div>
        </div>
    </div>
</div>

<div id="CrewMedical" class="content">
    <div class="page-shell">
        <div class="panel-wrapper">
            <div class="history-wrapper">
                <div id="crew-medical-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="OnboardPharmacy" class="content">
    <div class="page-shell"></div>
</div>

<div id="OnboardEquipment" class="content">
    <div class="page-shell"></div>
</div>

<div id="VesselCrewInfo" class="content">
    <div class="page-shell">
        <div class="panel-wrapper">
        <div class="collapsible" style="margin-bottom:15px;">
            <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">â–¸</span><span style="font-weight:700;">Vessel Information</span>
            </div>
            <div class="col-body" style="padding:15px; background:#f8f9fa;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px; font-size:13px;">
                    <div>
                        <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Vessel Name</label>
                        <input type="text" id="vessel-name" style="padding:8px; width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Registration Number</label>
                        <input type="text" id="vessel-registration" style="padding:8px; width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Flag Country</label>
                        <input type="text" id="vessel-flag" style="padding:8px; width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Home Port</label>
                        <input type="text" id="vessel-homeport" style="padding:8px; width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Call Sign</label>
                        <input type="text" id="vessel-callsign" style="padding:8px; width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Tonnage</label>
                        <input type="text" id="vessel-tonnage" style="padding:8px; width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Crew Capacity</label>
                        <input type="text" id="vessel-crewcap" style="padding:8px; width:100%;">
                    </div>
                </div>
                <button onclick="saveVesselInfo()" class="btn btn-sm" style="background:var(--blue); width:100%;">Save Vessel Info</button>
            </div>
        </div>
        <div class="collapsible" style="margin-bottom:15px;">
            <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">â–¸</span><span style="font-weight:700;">Crew Information</span>
            </div>
            <div class="col-body" style="padding:15px; background:#f8f9fa;">
                <div class="collapsible" style="margin-bottom:15px;">
                    <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                        <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">â–¸</span><span style="font-weight:700;">Add New Crew Member</span>
                    </div>
                    <div class="col-body" style="padding:15px; background:#f8f9fa;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:13px;">
                        <div><label style="font-size:11px; margin-bottom:2px;">First Name *</label><input type="text" id="cn-first" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Middle Name(s)</label><input type="text" id="cn-middle" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Last Name *</label><input type="text" id="cn-last" style="padding:6px; width:100%;"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:13px;">
                        <div><label style="font-size:11px; margin-bottom:2px;">Sex *</label><select id="cn-sex" style="padding:6px; width:100%;">
                            <option value="">Select...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Non-binary">Non-binary</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Birthdate *</label><input type="date" id="cn-birthdate" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Position *</label><select id="cn-position" style="padding:6px; width:100%;">
                            <option value="">Select...</option>
                            <option value="Captain">Captain</option>
                            <option value="Crew">Crew</option>
                            <option value="Passenger">Passenger</option>
                        </select></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:13px;">
                        <div><label style="font-size:11px; margin-bottom:2px;">Citizenship *</label><input type="text" id="cn-citizenship" list="countries" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Passport Number *</label><input type="text" id="cn-passport" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Issue Date</label><input type="date" id="cn-pass-issue" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Expiry Date</label><input type="date" id="cn-pass-expiry" style="padding:6px; width:100%;"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:13px;">
                        <div><label style="font-size:11px; margin-bottom:2px;">Cell/WhatsApp</label><input type="text" id="cn-phone" placeholder="+1234567890" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Passport Photo/PDF</label><input type="file" id="cn-passport-photo" accept="image/*,.pdf" style="padding:4px; width:100%; font-size:11px;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Passport Page Photo/PDF</label><input type="file" id="cn-passport-page" accept="image/*,.pdf" style="padding:4px; width:100%; font-size:11px;"></div>
                    </div>
                    <div style="margin-bottom:8px;"><label style="font-size:12px; font-weight:bold;">Emergency Contact</label></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:13px;">
                        <div><label style="font-size:11px; margin-bottom:2px;">Name</label><input type="text" id="cn-emerg-name" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Relationship</label><input type="text" id="cn-emerg-rel" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Phone</label><input type="text" id="cn-emerg-phone" style="padding:6px; width:100%;"></div>
                        <div><label style="font-size:11px; margin-bottom:2px;">Email</label><input type="email" id="cn-emerg-email" style="padding:6px; width:100%;"></div>
                    </div>
                    <div style="margin-bottom:10px; font-size:13px;">
                        <label style="font-size:11px; margin-bottom:2px;">Emergency Contact Notes</label>
                        <input type="text" id="cn-emerg-notes" placeholder="Additional emergency contact information" style="padding:6px; width:100%;">
                    </div>
                    <datalist id="countries">
                        <option value="USA"><option value="Canada"><option value="UK"><option value="Australia"><option value="New Zealand"><option value="France"><option value="Germany"><option value="Spain"><option value="Italy"><option value="Netherlands"><option value="Singapore"><option value="Malaysia"><option value="Thailand"><option value="Philippines"><option value="Japan"><option value="China"><option value="India">
                    </datalist>
                    <button onclick="addCrew()" class="btn btn-sm" style="background:var(--dark); width:100%;">+ Add Crew Member</button>
                </div>
                </div>

                <div id="crew-info-list"></div>
            </div>
        </div>
    </div>
</div>
</div>

<div id="Settings" class="content">
    <div class="page-shell">
        <div class="panel-wrapper">
            <div class="collapsible" style="margin-bottom:12px;">
                <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                    <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">â–¸</span><span style="font-weight:700;">Triage Mode (Clinical Response)</span>
                </div>
                <div class="col-body" style="padding:12px; background:#f8f9fa;">
                    <label>Instruction Text Block</label>
                    <textarea id="triage_instruction" style="height:120px;"></textarea>
                    <div style="display:flex; gap:20px; margin-top:15px;">
                        <div>Temp: <input type="number" id="tr_temp" step="0.1" style="width:60px;"></div>
                        <div>Tokens: <input type="number" id="tr_tok" style="width:80px;"></div>
                        <div>Top-P: <input type="number" id="tr_p" step="0.05" style="width:60px;"></div>
                    </div>
                </div>
            </div>
            <div class="collapsible" style="margin-bottom:12px;">
                <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                    <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">â–¸</span><span style="font-weight:700;">Inquiry Mode (Research/Academic)</span>
                </div>
                <div class="col-body" style="padding:12px; background:#f8f9fa;">
                    <label>Instruction Text Block</label>
                    <textarea id="inquiry_instruction" style="height:120px;"></textarea>
                    <div style="display:flex; gap:20px; margin-top:15px;">
                        <div>Temp: <input type="number" id="in_temp" step="0.1" style="width:60px;"></div>
                        <div>Tokens: <input type="number" id="in_tok" style="width:80px;"></div>
                        <div>Top-P: <input type="number" id="in_p" step="0.05" style="width:60px;"></div>
                    </div>
                </div>
            </div>
            <div class="collapsible" style="margin-bottom:12px;">
                <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                    <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">â–¸</span><span style="font-weight:700;">Global Mission Context</span>
                </div>
                <div class="col-body" style="padding:12px; background:#f8f9fa;">
                    <textarea id="mission_context" style="height:60px;"></textarea>
                    <button onclick="saveSettings()" class="btn" style="width:100%; background:var(--dark); margin-top:20px;">SYNC SYSTEM PARAMETERS</button>
                </div>
            </div>
            <div class="collapsible">
                <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                    <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">â–¸</span><span style="font-weight:700;">Crew Credentials</span>
                </div>
                <div class="col-body" style="padding:12px; background:#f8f9fa;">
                    <div id="crew-credentials"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/chat.js?v=2000"></script>
<script src="/static/js/crew.js?v=2000"></script>
<script src="/static/js/settings.js?v=2000"></script>
<script src="/static/js/main.js?v=2000"></script>
</body>
</html>
