<!DOCTYPE html>
<!-- =============================================================================
     Author: Rick Escher
     Project: SailingMedAdvisor
     Context: Google HAI-DEF Framework
     Models: Google MedGemmas
     Program: Kaggle Impact Challenge
     ========================================================================== -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MedGemma Master v5.7</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --page-width: 100%; --frame-padding: 8px; --frame-width: min(calc(100vw - (var(--frame-padding) * 2)), calc((100vh - (var(--frame-padding) * 2)) * 16 / 9)); --frame-height: min(calc(100vh - (var(--frame-padding) * 2)), calc((100vw - (var(--frame-padding) * 2)) * 9 / 16)); --banner-height: 68px; --triage: #c1121f; --inquiry: #2e7d32; --green: #2e7d32; --red: #c62828; --dark: #2c3e50; --bg: #f4f7f6; --splash-purple: #7452B9; --tabbar-bg: {{ '#7452B9' if use_splash_purple_tabbar else '#2c3e50' }}; }
        html, body { width: 100%; height: 100%; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0c1522; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: var(--frame-padding); box-sizing: border-box; overflow: hidden; }
        .app-frame { width: var(--frame-width); height: var(--frame-height); background: var(--bg); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #c9d2dc; box-shadow: 0 8px 24px rgba(9, 22, 39, 0.35); }
        .nav { background: var(--tabbar-bg); display: flex; padding: 0; min-height: var(--banner-height); align-items: stretch; flex-shrink: 0; max-width: var(--page-width); width: 100%; margin: 0 auto; box-sizing: border-box; gap: 8px; position: sticky; top: 0; z-index: 1000; }
        .page-shell { max-width: var(--page-width); margin: 0 auto; width: 100%; box-sizing: border-box; }
        .tab { color: white; background: none; border: none; padding: 0 10px; cursor: pointer; font-weight: 900; font-size: 16px; flex: 1; text-align: center; display: flex; align-items: center; justify-content: center; align-self: stretch; min-height: var(--banner-height); }
        .tab.active { color: #ffd54f; background: var(--inquiry); border-radius: 4px; }
        .tab-triage.active { background: var(--triage); }
        .tab-triage { flex: 1.2; font-weight: 900; }
        .tab-nowrap { white-space: nowrap; }
        .tab-config { color: white; }
        .content { flex-grow: 1; padding: 15px; overflow-y: auto; display: none; flex-direction: column; background: var(--bg); min-height: 0; }
        .page-shell { max-width: var(--page-width); margin: 0 auto; width: 100%; box-sizing: border-box; }
        .page-body { display: flex; gap: 16px; align-items: stretch; width: 100%; position: relative; }
        .page-body.sidebar-open .page-main { margin-right: 448px; padding-right: 24px; }
        .page-body.sidebar-collapsed .page-main { margin-right: 96px; padding-right: 16px; }
        .page-main { flex: 1; min-width: 0; display: flex; flex-direction: column; transition: padding-right 0.25s ease, margin-right 0.25s ease; }
        .page-main > .page-shell,
        .page-main > .panel-wrapper,
        .page-main > .history-wrapper { max-width: 100%; width: 100%; }
        .page-sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: 420px; min-width: 340px; max-width: 500px; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.07); display: flex; flex-direction: column; transition: width 0.25s ease, min-width 0.25s ease; overflow: hidden; }
        .page-sidebar.collapsed { width: 52px; min-width: 52px; }
        .sidebar-toggle { background: none; border: none; padding: 10px; cursor: pointer; font-weight: 800; text-align: left; display: flex; align-items: center; gap: 8px; color: var(--dark); }
        .sidebar-toggle:hover { background: #f5f5f5; }
        .sidebar-content { padding: 0 14px 14px 14px; overflow-y: auto; flex: 1; }
        .page-sidebar.collapsed .sidebar-content { display: none; }
        .sidebar-section { border-bottom: 1px solid #eee; padding: 12px 0; }
        .sidebar-section:last-child { border-bottom: none; }
        .sidebar-title { font-weight: 800; color: var(--dark); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .sidebar-body { color: #4a5568; font-size: 13px; line-height: 1.5; }
        .sidebar-section.hidden { display: none; }
        .sidebar-pill { background: #f0f4f8; color: #2c3e50; padding: 3px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
        /* Triage page sizing */
        #Chat .triage-wrapper { min-height: 0; height: 100%; }
        
        .banner { height: var(--banner-height); padding: 0 20px; color: white; font-weight: 900; display: flex; align-items: center; gap: 12px; flex-wrap: nowrap; border-radius: 0; background: var(--triage); transition: 0.3s; max-width: var(--page-width); margin: 0 auto; box-sizing: border-box; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: sticky; top: var(--banner-height); z-index: 900; }
        .banner-controls { display: none; align-items: center; gap: 10px; flex: 1; min-width: 320px; flex-wrap: wrap; }
        .banner-controls select { padding: 10px; font-weight: bold; }
        .banner-controls button { height: 44px; }
        .banner-label { font-weight: 700; }
        .mode-toggle { padding: 10px 16px; font-weight: 800; color: var(--dark); border: 1px solid #ccc; border-radius: 6px; cursor: pointer; min-width: 140px; background: white; }
        .triage-top-controls {
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 108px minmax(0, 1fr) minmax(0, 0.95fr) 124px;
            align-items: center;
            gap: 6px;
            min-width: 0;
            overflow: hidden;
        }
        .triage-top-controls-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 15px;
            font-weight: 800;
            color: #000;
            min-width: 0;
            white-space: nowrap;
        }
        .triage-pathway-title {
            font-size: 15px;
            font-weight: 800;
            color: #000;
            letter-spacing: 0;
        }
        .triage-top-controls #p-select,
        .triage-top-controls #model-select {
            width: 100%;
            min-width: 0;
            max-width: 100%;
        }
        .triage-top-controls #priv-btn {
            width: 100%;
            min-width: 0;
            padding: 10px 10px;
            font-size: 14px;
            white-space: nowrap;
        }
        #triage-condition-selects {
            grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
            gap: 8px !important;
        }
        #triage-condition-selects select {
            padding: 7px !important;
        }
        .banner.inquiry-mode { background: var(--inquiry); }
        /* Neutralize glow when logging is on (no privacy) */
        .banner.no-privacy { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .banner.private-mode { box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        .triage-wrapper { max-width: var(--page-width); margin: 0 auto; border: 1px solid #ddd; border-top: none; display: flex; flex-direction: column; flex: 1; width: 100%; min-height: 0; }
        .chat-area { background: white; border-radius: 0; border: none; display: flex; flex-direction: column; flex: 1; min-height: 0; width: 100%; }
        .chat-area > div { width: 100%; box-sizing: border-box; }
        .display { flex-grow: 1; padding: 20px; overflow-y: auto; background:#fff; border:1px solid #e0e0e0; border-radius:6px; min-height:180px; max-height:70vh; }
        .chat-transcript { display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 12px 14px; border-radius: 12px; max-width: 82%; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 6px; }
        .chat-message.user { align-self: flex-end; background: #eef2ff; border: 1px solid #c7d4ff; }
        .chat-message.assistant { align-self: flex-start; background: #f8f9fa; border: 1px solid #e2e2e2; }
        .chat-meta { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.4px; }
        .chat-content { font-size: 14px; color: #222; line-height: 1.45; }
        .chat-content p { margin: 0 0 8px; }
        .chat-content p:last-child { margin-bottom: 0; }
        .chat-content ul,
        .chat-content ol { margin: 4px 0 10px 20px; padding-left: 14px; }
        .chat-content li { margin: 2px 0; }
        .response-block p { margin: 0 0 8px; }
        .response-block ul,
        .response-block ol { margin: 4px 0 10px 20px; padding-left: 14px; }
        .chat-content .chat-section-heading,
        .response-block .chat-section-heading { margin-top: 10px; margin-bottom: 6px; }
        .chat-content .chat-section-heading:first-child,
        .response-block .chat-section-heading:first-child { margin-top: 0; }
        .chat-content .chat-section-heading + ul,
        .chat-content .chat-section-heading + ol,
        .response-block .chat-section-heading + ul,
        .response-block .chat-section-heading + ol { margin-top: 0; }
        .chat-content .chat-section-label,
        .response-block .chat-section-label { font-weight: 900; letter-spacing: 0.1px; color: #0f2942; }
        .chat-empty-state {
            color: #6b7280;
            font-size: 14px;
            text-align: left;
            width: auto;
            margin: 0;
            padding: 0;
            line-height: 1.4;
        }
        .chat-triage-meta { margin-top: 6px; font-size: 12px; color: #444; background: #fffaf7; border: 1px dashed #e2b6b6; border-radius: 6px; padding: 6px 8px; }
        .chat-message { max-width: 82%; padding: 12px 14px; border-radius: 10px; line-height: 1.5; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .chat-message.user { align-self: flex-end; background: #e8f5e9; border: 1px solid #cfe8d6; }
        .chat-message.assistant { align-self: flex-start; background: #f3f6fa; border: 1px solid #d7e2ef; }
        .chat-meta { font-size: 11px; color: #6b7280; margin-top: 6px; }
        .chat-composer { margin-top: 12px; display: none; gap: 10px; flex-direction: column; }
        .chat-composer textarea { min-height: 90px; }
        .chat-composer-row { display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
        .chat-composer-row select { padding: 8px; min-width: 200px; }
        .response-block { border-left: 6px solid var(--inquiry); padding: 15px; margin: 15px 0; background: #f9f9f9; }
        .history-list { display: flex; flex-direction: column; gap: 8px; }
        .history-item { border: 1px solid #ddd; border-radius: 6px; background: #fff; }
        .history-header { padding: 6px 10px; display: flex; align-items: center; cursor: pointer; font-weight: bold; gap: 10px; min-height: 38px; }
        .history-body { padding: 10px 12px; border-top: 1px solid #eee; display: none; }
        .history-wrapper { max-width: var(--page-width); width: 100%; margin: 0 auto; border: 1px solid #ddd; background: #fff; padding: 15px; box-sizing: border-box; }
        .panel-wrapper { max-width: var(--page-width); width: 100%; margin: 0 auto; border: 1px solid #ddd; background: #fff; padding: 15px; box-sizing: border-box; }
        .history-response { margin: 0; }
        .history-action-btn { min-width: 90px; visibility: hidden; justify-content: center; }
        .history-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-arrow { font-size: 18px; width: 18px; text-align: center; }
        .crew-med-header { padding: 6px 10px !important; min-height: 38px; display: flex; align-items: center; gap: 10px; }
        .dev-tag { display: none; background: #fff5d7; color: #8a5a00; border: 1px dashed #e0b15c; border-radius: 4px; padding: 2px 6px; font-size: 11px; font-weight: 800; letter-spacing: 0.2px; text-transform: uppercase; }
        .mode-developer .dev-tag { display: inline-block; }
        .mode-user .user-adv-only { display: none !important; }
        #CrewMedical .crew-med-header { background: #fff; font-size: 16px; }
        #VesselCrewInfo .panel-wrapper { font-size: 15px; }
        #VesselCrewInfo .col-body { font-size: 15px; }
        #VesselCrewInfo .col-body label { font-size: 13px !important; }
        #VesselCrewInfo .col-body input,
        #VesselCrewInfo .col-body select,
        #VesselCrewInfo .col-body textarea { font-size: 15px; }

        .collapsible { background: white; border: 1px solid #ddd; margin-bottom: 4px; border-radius: 4px; }
        .col-header { padding: 8px 12px; cursor: pointer; background: #f8f9fa; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
        .col-body { padding: 12px; display: none; }
        .compact-textarea { height: 80px; font-size: 13px; }
        .btn-row { display: flex; gap: 8px; margin-top: 10px; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .crew-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .btn { padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .export-cta-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 0.2px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.15s ease, filter 0.15s ease, box-shadow 0.15s ease;
        }
        .export-cta-btn:hover { transform: translateY(-1px); filter: brightness(1.04); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.24); }
        .export-cta-btn:active { transform: translateY(0); }
        #crew-csv-btn.export-cta-btn,
        #crew-immigration-zip-btn.export-cta-btn {
            background: var(--inquiry) !important;
            border-color: rgba(255, 213, 79, 0.55);
        }
        .vessel-photo-grid { display: grid; grid-template-columns: repeat(3, minmax(180px, 1fr)); gap: 12px; }
        .vessel-photo-card { border: 1px solid #c8d9ed; border-radius: 6px; padding: 10px; background: #eef5ff; }
        .vessel-photo-preview {
            border: 1px dashed #9eb4cf;
            border-radius: 6px;
            background: #fff;
            min-height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            color: #52657a;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .vessel-photo-preview img { width: 100%; max-height: 190px; object-fit: contain; border-radius: 4px; cursor: pointer; }
        #priv-btn { border: 1px solid #222; color: white; }
        #priv-btn.is-private { border: 2px solid #fff; }
        /* Align green button text to the selected-tab palette */
        .btn[style*="var(--inquiry)"], .btn-sm[style*="var(--inquiry)"] { color: #ffd54f !important; }
        .config-card { background: white; padding: 25px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; color: var(--dark); }
        textarea { width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-sizing: border-box; font-family: inherit; }
        
        .loading-indicator { color: #666; font-style: italic; padding: 10px; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Mobile-friendly tweaks */
        @media (max-width: 768px) {
            body { font-size: 15px; }
            .page-shell { padding: 0 10px; }
            .panel-wrapper, .history-wrapper, .triage-wrapper { border-radius: 0; }
            .btn, .btn-sm { width: 100%; justify-content: center; box-sizing: border-box; }
            .btn-row { flex-direction: column; }
            .collapsible .col-body { padding: 10px !important; }
            .collapsible .col-header { padding: 10px !important; }
            .triage-wrapper textarea,
            #msg,
            #prompt-preview { font-size: 15px; }
            .triage-top-controls .btn,
            .triage-top-controls .btn-sm { width: auto; }
            #triage-condition-selects { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            #medication-add-body .col-body,
            #medication-add-body .col-header,
            #equipment-add-body .col-body,
            #equipment-add-body .col-header,
            #consumables-add-body .col-body,
            #consumables-add-body .col-header { padding: 10px !important; }
            #medication-add-body [style*="grid"] { grid-template-columns: 1fr !important; }
            #equipment-add-body [style*="grid"] { grid-template-columns: 1fr !important; }
            #consumables-add-body [style*="grid"] { grid-template-columns: 1fr !important; }
            #vessel-info [style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
            .vessel-photo-grid { grid-template-columns: 1fr !important; }
            #crew-info-list [style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
            #medication-add-body button,
            #equipment-add-body button,
            #consumables-add-body button,
            #medication-add-body input,
            #medication-add-body select,
            #medication-add-body textarea { width: 100%; box-sizing: border-box; }
            .page-sidebar { position: static; width: 100%; box-shadow: none; margin-top: 10px; }
            .page-body { flex-direction: column; }
            .page-body.sidebar-open .page-main,
            .page-body.sidebar-collapsed .page-main { margin-right: 0; padding-right: 0; }
        .page-sidebar .sidebar-toggle { width: 100%; justify-content: center; }
        .nav { flex-wrap: wrap; }
        .tab { flex: 1 1 50%; font-size: 14px; min-height: 52px; }
    }
    /* Blocking modal while GPU chat is running */
    #chat-blocker {
        display: none !important;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.65);
        z-index: 9000;
        align-items: center;
        justify-content: center;
        padding: 16px;
        box-sizing: border-box;
        pointer-events: none;
    }
    #chat-blocker.active { display: flex !important; pointer-events: auto; }
    #chat-blocker .modal {
        background: #fff;
        border-radius: 10px;
        padding: 18px;
        max-width: 520px;
        width: 100%;
        box-shadow: 0 12px 32px rgba(0,0,0,0.2);
        text-align: center;
    }
    #chat-blocker h3 { margin: 0 0 10px 0; color: #1f2d3d; }
    #chat-blocker p { margin: 8px 0; color: #2c3e50; line-height: 1.5; }
    #chat-blocker .spinner {
        width: 40px; height: 40px;
        border-radius: 50%;
        border: 4px solid #e0e0e0;
        border-top-color: var(--inquiry);
        margin: 14px auto;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    <script>
        (function primeUserMode() {
            try {
                const stored = localStorage.getItem('user_mode') || 'user';
                const cls = `mode-${stored}`;
                document.documentElement.classList.add(cls);
            } catch (err) { /* ignore */ }
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const stored = localStorage.getItem('user_mode') || 'user';
                    const cls = `mode-${stored}`;
                    document.body.classList.remove('mode-user', 'mode-advanced', 'mode-developer');
                    document.body.classList.add(cls);
                } catch (err) { /* ignore */ }
            }, { once: true });
        })();
    </script>
</head>
<body>
<div id="app-frame" class="app-frame">

<div class="nav">
    <span class="dev-tag">dev:tabbar</span>
    <button class="tab tab-triage active" onclick="showTab(event, 'Chat')"><span class="dev-tag">dev:tab-chat</span>üö® MEDGEMMA CONSULTATION</button>
    <button class="tab tab-nowrap" onclick="showTab(event, 'CrewMedical')"><span class="dev-tag">dev:tab-consult-log</span>üìã CONSULTATION LOG</button>
    <button class="tab" onclick="showTab(event, 'OnboardEquipment')"><span class="dev-tag">dev:tab-medical-chest</span>üß∞ MEDICAL CHEST</button>
    <button class="tab" onclick="showTab(event, 'VesselCrewInfo')"><span class="dev-tag">dev:tab-vessel-crew</span>‚õµ VESSEL & CREW</button>
    <button class="tab tab-config" onclick="showTab(event, 'Settings')"><span class="dev-tag">dev:tab-settings</span>‚öôÔ∏è SETTINGS</button>
</div>

<div class="page-shell">
        <div id="banner" class="banner">
        <span class="dev-tag">dev:banner</span>
        <div id="banner-controls-triage" class="banner-controls" style="align-items:center; gap:10px;">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <span style="font-weight:800;">Consultation Mode:</span><span class="dev-tag">dev:mode-label</span>
                <select id="mode-select" class="mode-toggle" style="min-width:200px; background:white; color:var(--dark);" onchange="setMode(this.value)">
                    <option value="triage">üö® Triage Consultation</option>
                    <option value="inquiry">üìò Inquiry Consultation</option>
                </select>
                <span class="dev-tag">dev:mode-select</span>
            </div>
        </div>
        <div id="banner-controls-crew" class="banner-controls" style="justify-content:space-between; gap:12px;">
            <div style="display:flex; gap:12px; align-items:center; flex:1;">
                <button id="crew-csv-btn" onclick="exportCrewList()" class="btn btn-sm export-cta-btn" style="background:var(--inquiry); display:none; align-self:center;"><span class="dev-tag">dev:btn-crew-csv</span>üìã Crew List CSV</button>
                <button id="crew-immigration-zip-btn" onclick="exportImmigrationZip()" class="btn btn-sm export-cta-btn" style="background:var(--inquiry); display:none; align-self:center;"><span class="dev-tag">dev:btn-crew-immigration-zip</span>üõÇ Export Zip File for Immigration</button>
                <button id="crew-med-export-all-btn" onclick="exportAllMedical()" class="btn btn-sm" style="background:var(--inquiry); display:none;"><span class="dev-tag">dev:btn-crew-export-all</span>üì§ Export All Medical</button>
            </div>
        </div>
    </div>
</div>

<div id="Chat" class="content" style="display:flex;">
            <div class="page-shell">
                <div class="page-body sidebar-open">
                    <div class="page-main">
                        <div class="triage-wrapper">
                            <div class="chat-area">
                    <div class="collapsible" style="margin-bottom:12px;">
                        <div id="query-form-header" class="col-header crew-med-header" data-pref-key="query-form-open" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start; align-items:center; gap:12px;">
                            <span class="dev-tag">dev:triage-form</span>
                            <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñæ</span>
                            <span id="query-form-title" style="font-weight:700; white-space:nowrap;">Start New Triage Consultation</span>
                        </div>
                        <div id="query-form-body" class="col-body" style="padding:16px; background:#f4f4f4; display:block;">
                            <div class="triage-top-controls">
                <span class="triage-top-controls-label">
                    Crew/Patient
                    <span class="dev-tag">dev:triage-patient</span>
                </span>
                <select id="p-select" style="padding:10px; font-weight:700;"><option value="">Unnamed Crew Member</option></select>
                <select id="model-select" style="padding:10px; font-weight:700;">
                    <option value="google/medgemma-1.5-4b-it">medgemma-1.5-4b-it (local)</option>
                    <option value="google/medgemma-27b-text-it">medgemma-27b-text-it (local)</option>
                </select>
                <button onclick="togglePriv()" id="priv-btn" class="btn" style="background:#555;"><span class="dev-tag">dev:btn-logging</span>LOGGING: ON</button>
            </div>
                            <span class="dev-tag">dev:textarea-chat-msg</span>
                            <textarea id="msg" style="height:105px;" placeholder="Describe what's happening"></textarea>
                            <div id="triage-condition-container">
                                <div id="triage-condition-selects" style="display:grid; margin-top:0;">
                                    <div id="triage-consciousness-field">
                                        <label for="triage-consciousness" style="font-size:12px; color:#333;">Consciousness</label>
                                        <span class="dev-tag">dev:sel-triage-consciousness</span>
                                        <select id="triage-consciousness" style="padding:8px; width:100%;">
                                            <option value="">Select...</option>
                                            <option value="Alert and oriented">Alert and oriented</option>
                                            <option value="Confused / disoriented">Confused / disoriented</option>
                                            <option value="Responds to voice only">Responds to voice only</option>
                                            <option value="Responds to pain only">Responds to pain only</option>
                                            <option value="Unresponsive">Unresponsive</option>
                                        </select>
                                    </div>
                                    <div id="triage-breathing-field">
                                        <label for="triage-breathing" style="font-size:12px; color:#333;">Breathing</label>
                                        <span class="dev-tag">dev:sel-triage-breathing</span>
                                        <select id="triage-breathing" style="padding:8px; width:100%;">
                                            <option value="">Select...</option>
                                            <option value="Normal">Normal</option>
                                            <option value="Rapid">Rapid</option>
                                            <option value="Slow">Slow</option>
                                            <option value="Labored / struggling">Labored / struggling</option>
                                            <option value="Gasping / irregular">Gasping / irregular</option>
                                            <option value="Not breathing">Not breathing</option>
                                        </select>
                                    </div>
                                    <div id="triage-circulation-field">
                                        <label for="triage-circulation" style="font-size:12px; color:#333;">Circulation</label>
                                        <span class="dev-tag">dev:sel-triage-circulation</span>
                                        <select id="triage-circulation" style="padding:8px; width:100%;">
                                            <option value="">Select...</option>
                                            <option value="Normal pulse and warm skin">Normal pulse and warm skin</option>
                                            <option value="Rapid pulse">Rapid pulse</option>
                                            <option value="Weak / thready pulse">Weak / thready pulse</option>
                                            <option value="Irregular pulse">Irregular pulse</option>
                                            <option value="No pulse">No pulse</option>
                                            <option value="Severe uncontrolled bleeding">Severe uncontrolled bleeding</option>
                                        </select>
                                    </div>
                                    <div id="triage-overall-stability-field">
                                        <label for="triage-overall-stability" style="font-size:12px; color:#333;">Overall Stability</label>
                                        <span class="dev-tag">dev:sel-triage-overall-stability</span>
                                        <select id="triage-overall-stability" style="padding:8px; width:100%;">
                                            <option value="">Select...</option>
                                            <option value="Stable - no immediate danger">Stable - no immediate danger</option>
                                            <option value="Concerning - abnormal, needs urgent evaluation">Concerning - abnormal, needs urgent evaluation</option>
                                            <option value="Unstable - high risk, urgent treatment required">Unstable - high risk, urgent treatment required</option>
                                            <option value="Critical - life-saving intervention needed now">Critical - life-saving intervention needed now</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="triage-pathway-container" class="collapsible" style="margin-top:12px; margin-bottom:8px;">
                                <div id="triage-pathway-header" class="col-header crew-med-header" data-pref-key="triage-pathway-open" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start; align-items:center;">
                                    <span class="dev-tag">dev:triage-pathway</span>
                                    <span class="detail-icon history-arrow" style="font-size:16px; margin-right:8px;">‚ñ∏</span>
                                    <span class="triage-pathway-title">Clinical Triage Pathway (Optional)</span>
                                </div>
                                <div id="triage-pathway-body" class="col-body" style="padding:10px 0 0; display:none; background:transparent;">
                                    <div id="triage-meta-selects" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; margin-top:0;">
                                        <div id="triage-domain-field">
                                            <label for="triage-domain" style="font-size:12px; color:#333;">Domain</label>
                                            <span class="dev-tag">dev:sel-triage-domain</span>
                                            <select id="triage-domain" style="padding:8px; width:100%;">
                                                <option value="">Select...</option>
                                                <option value="Trauma">Trauma</option>
                                                <option value="Medical illness">Medical illness</option>
                                                <option value="Environmental exposure">Environmental exposure</option>
                                                <option value="Dental">Dental</option>
                                                <option value="Behavioral / psychological">Behavioral / psychological</option>
                                            </select>
                                        </div>
                                        <div id="triage-problem-field">
                                            <label for="triage-problem" style="font-size:12px; color:#333;">Problem / Injury Type</label>
                                            <span class="dev-tag">dev:sel-triage-problem</span>
                                            <select id="triage-problem" style="padding:8px; width:100%;">
                                                <option value="">Select...</option>
                                                <option value="Laceration">Laceration</option>
                                                <option value="Bleeding wound (non-laceration)">Bleeding wound (non-laceration)</option>
                                                <option value="Fracture">Fracture</option>
                                                <option value="Dislocation / severe sprain">Dislocation / severe sprain</option>
                                                <option value="Burn">Burn</option>
                                                <option value="Infection / abscess">Infection / abscess</option>
                                                <option value="Embedded foreign body">Embedded foreign body</option>
                                                <option value="Eye injury">Eye injury</option>
                                                <option value="Marine bite / sting / envenomation">Marine bite / sting / envenomation</option>
                                                <option value="Heat illness">Heat illness</option>
                                                <option value="Cold exposure / hypothermia">Cold exposure / hypothermia</option>
                                                <option value="General illness (vomiting, fever, weakness)">General illness (vomiting, fever, weakness)</option>
                                            </select>
                                        </div>
                                        <div id="triage-anatomy-field">
                                            <label for="triage-anatomy" style="font-size:12px; color:#333;">Anatomy</label>
                                            <span class="dev-tag">dev:sel-triage-anatomy</span>
                                            <select id="triage-anatomy" style="padding:8px; width:100%;">
                                                <option value="">Select...</option>
                                                <option value="Head">Head</option>
                                                <option value="Face / Eye">Face / Eye</option>
                                                <option value="Neck / Airway">Neck / Airway</option>
                                                <option value="Chest">Chest</option>
                                                <option value="Abdomen">Abdomen</option>
                                                <option value="Back / Spine">Back / Spine</option>
                                                <option value="Arm / Hand">Arm / Hand</option>
                                                <option value="Leg / Foot">Leg / Foot</option>
                                                <option value="Joint">Joint</option>
                                                <option value="Whole body / systemic">Whole body / systemic</option>
                                            </select>
                                        </div>
                                        <div id="triage-severity-field">
                                            <label for="triage-severity" style="font-size:12px; color:#333;">Mechanism / Cause</label>
                                            <span class="dev-tag">dev:sel-triage-severity</span>
                                            <select id="triage-severity" style="padding:8px; width:100%;">
                                                <option value="">Select...</option>
                                                <option value="Stable minor">Stable minor</option>
                                                <option value="Significant bleeding">Significant bleeding</option>
                                                <option value="Uncontrolled bleeding">Uncontrolled bleeding</option>
                                                <option value="Altered mental status">Altered mental status</option>
                                                <option value="Breathing difficulty">Breathing difficulty</option>
                                                <option value="Severe pain or functional loss">Severe pain or functional loss</option>
                                                <option value="Infection risk / sepsis signs">Infection risk / sepsis signs</option>
                                                <option value="Deteriorating over time">Deteriorating over time</option>
                                            </select>
                                        </div>
                                        <div id="triage-mechanism-field">
                                            <label for="triage-mechanism" style="font-size:12px; color:#333;">Severity / Complication</label>
                                            <span class="dev-tag">dev:sel-triage-mechanism</span>
                                            <select id="triage-mechanism" style="padding:8px; width:100%;">
                                                <option value="">Select...</option>
                                                <option value="Blunt impact">Blunt impact</option>
                                                <option value="Sharp cut">Sharp cut</option>
                                                <option value="Penetrating / Impaled">Penetrating / Impaled</option>
                                                <option value="Crush / compression">Crush / compression</option>
                                                <option value="Twist / overload (rope, winch)">Twist / overload (rope, winch)</option>
                                                <option value="High-tension recoil (snapback line)">High-tension recoil (snapback line)</option>
                                                <option value="Marine bite / sting">Marine bite / sting</option>
                                                <option value="Thermal exposure">Thermal exposure</option>
                                                <option value="Immersion / near drowning">Immersion / near drowning</option>
                                                <option value="Chemical / electrical exposure">Chemical / electrical exposure</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible" style="margin-top:12px;">
                                <div id="prompt-preview-header" class="col-header crew-med-header user-adv-only" style="background:#fff; justify-content:flex-start; align-items:center;" role="button" aria-expanded="false" tabindex="0">
                                    <span class="dev-tag">dev:triage-prompt</span>
                                    <span class="detail-icon history-arrow" style="font-size:16px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Dynamic Prompt Assembly</span>
                                    <div id="prompt-refresh-inline" style="margin-left:auto; display:none; align-items:center; gap:8px;">
                                        <div style="color:#555; font-size:12px;">Use Settings to change defaults.</div>
                                        <button onclick="refreshPromptPreview(true)" class="btn btn-sm" style="background:var(--inquiry);">Refresh from Settings</button>
                                    </div>
                                </div>
                                <div id="prompt-preview-container" class="col-body user-adv-only" style="padding:10px; background:#fff; display:none;">
                                    <textarea id="prompt-preview" style="width:100%; min-height:140px; padding:10px; border:1px solid #ccc; border-radius:4px;"></textarea>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap;">
                                <button onclick="runChat()" id="run-btn" class="btn" style="flex-grow:1; background:var(--triage); min-width:160px;">Submit to Start Triage Consultation</button>
                            </div>
                            <div id="model-availability-warning" style="display:none; margin-top:8px; color:#8a1f11; font-size:12px; font-weight:700;"></div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                        <span class="dev-tag">dev:triage-display</span>
                    </div>
                    <div id="display" class="display chat-transcript"><div class="chat-empty-state">No consultation response yet. Expand "Start New Triage Consultation" above and submit to generate guidance.</div></div>
                    <div id="chat-composer" class="chat-composer">
                        <textarea id="chat-input" placeholder="Type your follow-up..."></textarea>
                        <div class="chat-composer-row">
                            <span style="font-size:12px; font-weight:700; color:#333;">Model for this message</span>
                            <select id="chat-model-select">
                                <option value="google/medgemma-1.5-4b-it">medgemma-1.5-4b-it (local)</option>
                                <option value="google/medgemma-27b-text-it">medgemma-27b-text-it (local)</option>
                            </select>
                            <button onclick="sendChatMessage()" id="chat-send-btn" class="btn" style="background:var(--inquiry); min-width:160px;">SEND MESSAGE</button>
                        </div>
                        <div id="chat-model-availability-warning" style="display:none; margin-top:6px; color:#8a1f11; font-size:12px; font-weight:700;"></div>
                    </div>
                    </div>
                </div>
            </div>
            <div class="page-sidebar" data-tab="Chat" onclick="toggleSidebar(this)">
                <div style="display:flex; align-items:center; gap:6px;">
                    <button class="sidebar-toggle">Context ‚Üí</button>
                    <span class="dev-tag">dev:triage-sidebar</span>
                </div>
                <div class="sidebar-content">
                    {% include 'sidebars/sidebar_chat.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="CrewMedical" class="content">
    <div class="page-shell">
        <div class="page-body sidebar-open">
            <div class="page-main">
                <div class="page-shell">
                    <div class="history-wrapper" data-sidebar-id="crew-medical-section">
                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">
                            <span class="dev-tag">dev:crew-health-list</span>
                        </div>
                        <div id="crew-medical-list"></div>
                    </div>
                </div>
            </div>
            <div class="page-sidebar" data-tab="CrewMedical" onclick="toggleSidebar(this)">
                <div style="display:flex; align-items:center; gap:6px;">
                    <button class="sidebar-toggle">Context ‚Üí</button>
                    <span class="dev-tag">dev:crew-sidebar</span>
                </div>
                <div class="sidebar-content">
                    {% include 'sidebars/sidebar_crew_medical.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="OnboardEquipment" class="content">
    <div class="page-shell">
        <div class="page-body sidebar-open">
            <div class="page-main">
                <div class="collapsible" style="margin-bottom:12px;">
                    <div class="col-body" style="padding:12px; background:#f8f9fa;">
                        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
                            <label style="font-weight:700; font-size:12px;">Search Medical Chest:</label>
                            <input id="medchest-search-input" type="text" placeholder="Search medicines, equipment, consumables" style="padding:8px; min-width:280px;" onkeypress="if(event.key==='Enter'){searchMedicalChest();}">
                            <select id="medchest-search-scope" style="padding:8px; min-width:180px;">
                                <option value="all">All sections</option>
                                <option value="pharma">Pharmaceuticals</option>
                                <option value="equipment">Equipment</option>
                                <option value="consumables">Consumables</option>
                            </select>
                            <button class="btn btn-sm" style="background:var(--inquiry);" onclick="searchMedicalChest()">Search</button>
                        </div>
                        <div id="medchest-search-results" style="font-size:13px; color:#2c3e50;"></div>
                    </div>
                </div>
                <div class="page-shell">
                    <div class="panel-wrapper" data-sidebar-id="equipment-section">
                        <div class="collapsible">
                            <div class="col-header crew-med-header" data-sidebar-id="equipment-medication-section" onclick="toggleSection(this)" style="background:#e8f0ff; border:1px solid #c6d7ff; justify-content:flex-start;">
                                <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Pharmaceuticals</span><span id="pharmacy-count" style="margin-left:8px; font-weight:700; font-size:12px; color:#1f2d3d;">(0)</span><span class="dev-tag">dev:medicines-shell</span>
                            </div>
                            <div class="col-body" style="padding:12px; display:none; background:#f5f8ff; border:1px solid #d7e2ff; border-top:none;">
                                <div class="developer-only" style="display:none; margin-bottom:8px; display:flex; gap:8px; flex-wrap:wrap;">
                                    <button class="btn btn-sm" style="background:#0b8457;" onclick="exportPharmacyJSON()">Export Pharmaceuticals JSON</button>
                                    <button class="btn btn-sm" style="background:#1b4f72;" onclick="importPharmacyJSON()">Import Pharmaceuticals JSON</button>
                                </div>
                                <div class="collapsible" style="margin-bottom:12px;">
                                    <div id="medication-add-header" class="col-header crew-med-header" data-sidebar-id="equipment-medication-add" onclick="toggleSection(this)" style="background:#f4fff6; justify-content:flex-start;">
                                        <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Add Pharmaceuticals</span><span class="dev-tag">dev:medication-add</span>
                                    </div>
                                    <div id="medication-add-body" class="col-body" style="padding:12px; background:#f8f9fa; display:none;">
                                        <div class="collapsible" style="margin-bottom:12px;">
                                            <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#f4fff6; justify-content:flex-start;">
                                                <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Manual Entry</span><span class="dev-tag">dev:medication-add-form</span>
                                            </div>
                                            <div class="col-body" style="padding:10px; background:#fff; display:none;">
                                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap;">
                                            <label style="display:flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border:1px solid #ffcfe0; border-radius:6px; background:#fff; margin:0;">
                                                <input id="med-new-exclude" type="checkbox">
                                                Resource Currently Unavailable
                                            </label>
                                            <label style="display:flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border:1px solid #c7ddff; border-radius:6px; background:#fff; margin:0;">
                                                <input id="med-new-verified" type="checkbox">
                                                Verified
                                            </label>
                                            <label style="display:flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border:1px solid #c7ddff; border-radius:6px; background:#fff; margin:0;">
                                                <span style="font-weight:700;">User Label</span>
                                                <select id="med-new-sort" style="padding:6px 8px;" onchange="toggleCustomSortField()">
                                                    <option value="">Select...</option>
                                                    <option value="__custom">Custom...</option>
                                                </select>
                                                <input id="med-new-sort-custom" type="text" placeholder="Custom label" style="width:160px; padding:6px; margin-left:6px; display:none;">
                                            </label>
                                        </div>
                                        <div style="display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap:10px; margin-bottom:10px;">
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Generic Name *</label>
                                                <input id="med-new-name" type="text" style="width:100%; padding:8px;" placeholder="e.g., Amoxicillin">
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Brand Name</label>
                                                <input id="med-new-brand" type="text" style="width:100%; padding:8px;" placeholder="Also known as">
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Form</label>
                                                <input id="med-new-form" type="text" style="width:100%; padding:8px;" placeholder="Tablet, Capsule, etc.">
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Strength</label>
                                                <input id="med-new-strength" type="text" style="width:100%; padding:8px;" placeholder="500mg, 10mg/ml">
                                            </div>
                                            <div style="grid-column: span 2; display:grid; grid-template-columns: repeat(2, minmax(200px, 1fr)); gap:10px;">
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Priority Tier</label>
                                                    <select id="med-new-tier" style="width:100%; padding:8px;"></select>
                                                </div>
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Functional Subcategory</label>
                                                    <select id="med-new-tiercat" style="width:100%; padding:8px;"></select>
                                                </div>
                                            </div>
                                            <div style="grid-column: 1 / span 2; display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap:10px;">
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Current Quantity</label>
                                                    <input id="med-new-qty" type="number" style="width:100%; padding:8px;" placeholder="e.g., 24">
                                                </div>
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Minimum Threshold</label>
                                                    <input id="med-new-par" type="number" style="width:100%; padding:8px;" placeholder="e.g., 10">
                                                </div>
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Unit of Measure</label>
                                                    <input id="med-new-unit" type="text" style="width:100%; padding:8px;" placeholder="Bottle, Box, Blister">
                                                </div>
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Storage Location</label>
                                                <input id="med-new-loc" type="text" style="width:100%; padding:8px;" placeholder="Locker A, Fridge">
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Controlled Substance?</label>
                                                <select id="med-new-ctrl" style="width:100%; padding:8px;">
                                                    <option value="false">No</option>
                                                    <option value="true">Yes</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Primary Indication</label>
                                                <input id="med-new-indication" type="text" style="width:100%; padding:8px;" placeholder="What it's for">
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Allergy Warnings</label>
                                                <input id="med-new-allergy" type="text" style="width:100%; padding:8px;" placeholder="e.g., Contains Sulfa">
                                            </div>
                                            <div style="grid-column: span 2;">
                                                <label style="font-weight:700; font-size:12px;">Standard Dosage (adult reference)</label>
                                                <textarea id="med-new-dose" style="width:100%; padding:8px; min-height:60px;" placeholder="Include adult reference dosing, route, and frequency"></textarea>
                                            </div>
                                            <div style="grid-column: span 2;">
                                                <label style="font-weight:700; font-size:12px;">Notes</label>
                                                <textarea id="med-new-notes" style="width:100%; padding:8px; min-height:60px;" placeholder="Additional notes, precautions, or remarks"></textarea>
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Supplier / Manufacturer</label>
                                                <input id="med-new-sup" type="text" style="width:100%; padding:8px;" placeholder="Vendor or manufacturer">
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Expiry Date (optional)</label>
                                                <input id="med-new-exp" type="date" style="width:100%; padding:8px;">
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Expiry Quantity</label>
                                                <input id="med-new-exp-qty" type="number" style="width:100%; padding:8px;" placeholder="Qty tied to expiry">
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Batch / Lot</label>
                                                <input id="med-new-exp-batch" type="text" style="width:100%; padding:8px;" placeholder="Batch or lot number">
                                            </div>
                                        </div>
                                        <button onclick="addMedicationItem()" class="btn btn-sm" style="background:var(--dark); width:100%;">Add Pharmaceutical</button>
                                            </div>
                                        </div>
                                        <div class="collapsible" style="margin-top:12px;">
                                            <div class="col-header crew-med-header" data-sidebar-id="equipment-medication-who" onclick="toggleSection(this)" style="background:#f4fff6; justify-content:flex-start;">
                                                <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Import Selected Medicines From WHO's 'International Medical Guide for Ships'</span><span class="dev-tag">dev:med-who-import</span>
                                            </div>
                                            <div class="col-body" style="padding:12px; background:#f8f9fa; display:none;">
                                                <div class="dev-tag" style="margin-bottom:8px;">dev:med-who-controls</div>
                                                <div id="who-med-list" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px;"></div>
                                                <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                                                <input id="who-list-import-file" type="file" accept=".tsv,.txt" style="display:none;" onchange="handleWhoListFileImport(event)">
                                                <button class="btn btn-sm" style="background:#00695c;" onclick="openWhoListFilePicker()">Import WHO List</button>
                                                <button class="btn btn-sm" style="background:var(--inquiry);" onclick="addWhoMeds()">Copy selected to onboard inventory</button>
                                                <span style="font-size:12px; color:#555;">Columns: Generic name ¬∑ Also known as ¬∑ Dosage form/strength ¬∑ Indications ¬∑ Contraindications ¬∑ Consult doctor before using ¬∑ Adult dosage ¬∑ Unwanted effects ¬∑ Remarks</span>
                                                <span id="who-med-status" style="font-size:12px; color:#1f2d3d;"></span>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                                        <div class="collapsible" style="margin-bottom:12px;">
                                    <div class="col-body" style="padding:12px; background:#f8f9fa; display:block;">
                                        <div class="dev-tag" style="margin-bottom:6px;">dev:pharmacy-inventory</div>
                                        <div class="dev-tag" style="margin-bottom:6px;">dev:pharmacy-controls</div>
                                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
                                            <label style="font-size:12px; font-weight:700;">Sort by:</label>
                                            <select id="pharmacy-sort" style="padding:8px; min-width:180px;" onchange="handlePharmacySortChange()">
                                                <option value="sortCategory">User Label</option>
                                                <option value="generic">Generic Name</option>
                                                <option value="brand">Brand Name</option>
                                                <option value="strength">Strength</option>
                                                <option value="expiry">Expiry Date</option>
                                            </select>
                                            <span style="font-size:12px; color:#555;">User Labels are defined in Settings.</span>
                                        </div>
                                        <div class="dev-tag" style="margin-bottom:6px;">dev:pharmacy-list</div>
                                        <div id="pharmacy-list"></div>
                                    </div>
                                </div>
                                <div id="medication-list"></div>
                            </div>
                        </div>
                        <div class="collapsible">
                            <div id="equipment-section-header" class="col-header crew-med-header" data-sidebar-id="equipment-section" onclick="toggleSection(this)" style="background:#e9f7ef; border:1px solid #b6e3cc; justify-content:flex-start;">
                                <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Medical Equipment</span><span id="equipment-count" style="margin-left:8px; font-weight:700; font-size:12px; color:#1f2d3d;">(0)</span><span class="dev-tag">dev:equipment-shell</span>
                            </div>
                            <div class="col-body" style="padding:12px; display:none; background:#f7fffa; border:1px solid #c9ead6; border-top:none;">
                                <div id="equipment-add-container" class="collapsible" style="margin-bottom:12px;">
                                    <div id="equipment-add-header" class="col-header crew-med-header" data-sidebar-id="equipment-add" onclick="toggleSection(this)" style="background:#f4fff6; justify-content:flex-start;">
                                    <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Add Medical Equipment</span><span class="dev-tag">dev:equipment-add</span>
                                    </div>
                                    <div id="equipment-add-body" class="col-body" style="padding:12px; background:#f8f9fa; display:none;">
                                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">
                                            <button class="btn btn-sm" style="background:#1f2d3d;" onclick="exportEquipmentItems()">Export equipment to file</button>
                                            <input id="equipment-import-file" type="file" accept=".tsv,.txt" style="display:none;" onchange="handleEquipmentFileImport(event)">
                                            <button class="btn btn-sm" style="background:#00695c;" onclick="openEquipmentFilePicker()">Import equipment from file</button>
                                            <span style="font-size:12px; color:#555;">Tab-delimited: Name ¬∑ Quantity string ¬∑ Comment</span>
                                            <span id="equipment-import-status" style="font-size:12px; color:#1f2d3d;"></span>
                                        </div>
                                        <div class="dev-tag" style="margin-bottom:8px;">dev:equipment-add-form</div>
                                        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:10px; align-items:end;">
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Medical Equipment Name *</label>
                                                <input id="eq-new-name" type="text" style="width:100%; padding:8px;" placeholder="e.g., Oxygen Concentrator">
                                            </div>
                                            <div style="grid-column: span 2; display:grid; grid-template-columns: repeat(2, minmax(200px, 1fr)); gap:10px;">
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Priority Tier</label>
                                                    <select id="eq-new-tier" style="width:100%; padding:8px;"></select>
                                                </div>
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Functional Subcategory</label>
                                                    <select id="eq-new-tiercat" style="width:100%; padding:8px;"></select>
                                                </div>
                                            </div>
                                            <div>
                                                <label style="font-weight:700; font-size:12px;">Quantity</label>
                                                <input id="eq-new-qty" type="text" style="width:100%; padding:8px;" placeholder="e.g., 2 units">
                                            </div>
                                            <div style="grid-column: span 2;">
                                                <label style="font-weight:700; font-size:12px;">Storage Location</label>
                                                <input id="eq-new-loc" type="text" style="width:100%; padding:8px;" placeholder="Medical Bag 1, Locker B">
                                            </div>
                                            <div style="grid-column: span 2;">
                                                <label style="font-weight:700; font-size:12px;">Notes</label>
                                                <textarea id="eq-new-notes" style="width:100%; padding:8px; min-height:60px;"></textarea>
                                            </div>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                                            <input id="eq-new-exclude" type="checkbox">
                                            <label style="font-size:12px; line-height:1.2; margin:0;">Resource Currently Unavailable</label>
                                        </div>
                                        <button onclick="addMedicalStore()" class="btn btn-sm" style="background:var(--dark); width:100%;">Add Medical Equipment</button>
                                    </div>
                                </div>
                                <div class="dev-tag" style="margin-bottom:6px;">dev:equipment-list</div>
                                <div id="equipment-list"></div>
                            </div>
                        </div>
                        <div class="collapsible">
                            <div class="col-header crew-med-header" data-sidebar-id="equipment-consumables-section" onclick="toggleSection(this)" style="background:#f7eefc; border:1px solid #dec9f7; justify-content:flex-start;">
                                <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Consumables</span><span id="consumables-count" style="margin-left:8px; font-weight:700; font-size:12px; color:#1f2d3d;">(0)</span><span class="dev-tag">dev:consumables-shell</span>
                            </div>
                            <div class="col-body" style="padding:12px; display:none; background:#fcf7ff; border:1px solid #e6d7fb; border-top:none;">
                                <div id="consumables-add-container" class="collapsible" style="margin-bottom:12px;">
                                    <div id="consumables-add-header" class="col-header crew-med-header" data-sidebar-id="equipment-consumables-add" onclick="toggleSection(this)" style="background:#f4fff6; justify-content:flex-start;">
                                        <span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Add Consumable</span><span class="dev-tag">dev:consumables-add</span>
                                    </div>
                                    <div id="consumables-add-body" class="col-body" style="padding:12px; background:#f8f9fa; display:none;">
                                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">
                                        <button class="btn btn-sm" style="background:#1f2d3d;" onclick="exportConsumables()">Export consumables to clipboard</button>
                                            <input id="consumables-import-file" type="file" accept=".tsv,.txt" style="display:none;" onchange="handleConsumablesFileImport(event)">
                                            <button class="btn btn-sm" style="background:#00695c;" onclick="openConsumablesFilePicker()">Import consumables from file</button>
                                            <span style="font-size:12px; color:#555;">Tab-delimited: Name ¬∑ Quantity string ¬∑ Comment</span>
                                            <span id="consumables-import-status" style="font-size:12px; color:#1f2d3d;"></span>
                                        </div>
                                        <div class="dev-tag" style="margin-bottom:8px;">dev:consumables-add-form</div>
                                        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:10px; align-items:end;">
                                            <div>
                                                <div class="dev-tag">dev:consumable-name-field</div>
                                                <label style="font-weight:700; font-size:12px;">Consumable Name *</label>
                                                <input id="cons-new-name" type="text" style="width:100%; padding:8px;" placeholder="e.g., Gauze Pads">
                                            </div>
                                            <div>
                                                <div class="dev-tag">dev:consumable-qty-field</div>
                                                <label style="font-weight:700; font-size:12px;">Quantity</label>
                                                <input id="cons-new-qty" type="text" style="width:100%; padding:8px;" placeholder="e.g., 12 boxes or 50 strips">
                                            </div>
                                            <div style="grid-column: span 2; display:grid; grid-template-columns: repeat(2, minmax(200px, 1fr)); gap:10px;">
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Priority Tier</label>
                                                    <select id="cons-new-tier" style="width:100%; padding:8px;"></select>
                                                </div>
                                                <div>
                                                    <label style="font-weight:700; font-size:12px;">Functional Subcategory</label>
                                                    <select id="cons-new-tiercat" style="width:100%; padding:8px;"></select>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="dev-tag">dev:consumable-notes-field</div>
                                                <label style="font-weight:700; font-size:12px;">Notes</label>
                                                <textarea id="cons-new-notes" style="width:100%; padding:8px; min-height:60px;"></textarea>
                                            </div>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                                            <input id="cons-new-exclude" type="checkbox">
                                            <label style="font-size:12px; line-height:1.2; margin:0;">Resource Currently Unavailable</label>
                                        </div>
                                        <button onclick="addConsumableItem()" class="btn btn-sm" style="background:var(--dark); width:100%;"><span class="dev-tag">dev:consumable-add-btn</span>Add Consumable</button>
                                    </div>
                                </div>
                                <div class="dev-tag" style="margin-bottom:6px;">dev:consumables-list</div>
                                <div id="consumables-list" style="background:#fcf7ff; padding:4px; border-radius:4px; border:1px solid #e6d7fb;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page-sidebar" data-tab="OnboardEquipment" onclick="toggleSidebar(this)">
                <button class="sidebar-toggle">Context ‚Üí</button>
                        <div class="sidebar-content">
                            {% include 'sidebars/sidebar_equipment.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="VesselCrewInfo" class="content">
    <div class="page-shell">
        <div class="page-body sidebar-open">
            <div class="page-main">
                <div class="page-shell">
                    <div class="dev-tag" style="margin-bottom:8px;">dev:vessel-crew-tab</div>
                    <div class="panel-wrapper">
                <div class="collapsible" style="margin-bottom:15px;">
                    <div class="col-header crew-med-header" data-sidebar-id="vessel-info" onclick="toggleSection(this)" style="background:#e3f2fd; border:1px solid #c5ddf8; justify-content:flex-start;">
                        <span class="dev-tag">dev:vessel-info</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Vessel Information</span>
                    </div>
                    <div class="col-body" style="padding:15px; background:#f5faff; border:1px solid #c5ddf8; border-top:none;">
                        <div class="dev-tag" style="margin-bottom:6px;">dev:vessel-fields</div>
                        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                            <span id="vessel-save-status" style="font-size:12px; color:#2e7d32;"></span>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px; font-size:15px;">
                            <div>
                                <div class="dev-tag">dev:vessel-name</div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Vessel Name</label>
                                <input type="text" id="vessel-name" value="{{ vessel_prefill.vesselName | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <div class="dev-tag">dev:vessel-registration</div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Registration Number</label>
                                <input type="text" id="vessel-registration" value="{{ vessel_prefill.registrationNumber | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <div class="dev-tag">dev:vessel-flag</div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Flag Country</label>
                                <input type="text" id="vessel-flag" value="{{ vessel_prefill.flagCountry | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <div class="dev-tag">dev:vessel-homeport</div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Home Port</label>
                                <input type="text" id="vessel-homeport" value="{{ vessel_prefill.homePort | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <div class="dev-tag">dev:vessel-tonnage</div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Gross Tonnage</label>
                                <input type="text" id="vessel-tonnage" value="{{ vessel_prefill.tonnage | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <div class="dev-tag">dev:vessel-net-tonnage</div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Net/Register Tonnage</label>
                                <input type="text" id="vessel-net-tonnage" value="{{ vessel_prefill.netTonnage | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <div class="dev-tag">dev:vessel-callsign</div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Call Sign</label>
                                <input type="text" id="vessel-callsign" value="{{ vessel_prefill.callSign | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <div class="dev-tag">dev:vessel-mmsi</div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">MMSI Number</label>
                                <input type="text" id="vessel-mmsi" value="{{ vessel_prefill.mmsi | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Vessel Hull Number</label>
                                <input type="text" id="vessel-hull-number" value="{{ vessel_prefill.hullNumber | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Starboard Engine Brand/Model/Size</label>
                                <input type="text" id="vessel-starboard-engine" value="{{ vessel_prefill.starboardEngine | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Starboard Engine S/N</label>
                                <input type="text" id="vessel-starboard-sn" value="{{ vessel_prefill.starboardEngineSn | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Port Engine Brand/Model/Size</label>
                                <input type="text" id="vessel-port-engine" value="{{ vessel_prefill.portEngine | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Port Engine S/N</label>
                                <input type="text" id="vessel-port-sn" value="{{ vessel_prefill.portEngineSn | default('') }}" style="padding:8px; width:100%;">
                            </div>
                            <div>
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">RIB S/N</label>
                                <input type="text" id="vessel-rib-sn" value="{{ vessel_prefill.ribSn | default('') }}" style="padding:8px; width:100%;">
                            </div>
                        </div>
                        <div style="margin-bottom:8px;">
                            <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Vessel Photos &amp; Registration Images</label>
                            <div class="dev-tag">dev:vessel-photo-fields</div>
                        </div>
                        <div class="vessel-photo-grid">
                            <div class="vessel-photo-card">
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Boat Photo</label>
                                <div id="vessel-photo-preview-boatPhoto" class="vessel-photo-preview">No file uploaded.</div>
                                <input type="file" id="vessel-photo-input-boatPhoto" accept="image/*,.pdf" onchange="uploadVesselPhoto('boatPhoto', this)" style="font-size:12px; width:100%;">
                                <button class="btn btn-sm" style="background:var(--red); margin-top:8px; width:100%; padding:6px 10px;" onclick="deleteVesselPhoto('boatPhoto')">Delete</button>
                            </div>
                            <div class="vessel-photo-card">
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Registration Front</label>
                                <div id="vessel-photo-preview-registrationFrontPhoto" class="vessel-photo-preview">No file uploaded.</div>
                                <input type="file" id="vessel-photo-input-registrationFrontPhoto" accept="image/*,.pdf" onchange="uploadVesselPhoto('registrationFrontPhoto', this)" style="font-size:12px; width:100%;">
                                <button class="btn btn-sm" style="background:var(--red); margin-top:8px; width:100%; padding:6px 10px;" onclick="deleteVesselPhoto('registrationFrontPhoto')">Delete</button>
                            </div>
                            <div class="vessel-photo-card">
                                <label style="font-size:12px; font-weight:bold; margin-bottom:4px; display:block;">Registration Back</label>
                                <div id="vessel-photo-preview-registrationBackPhoto" class="vessel-photo-preview">No file uploaded.</div>
                                <input type="file" id="vessel-photo-input-registrationBackPhoto" accept="image/*,.pdf" onchange="uploadVesselPhoto('registrationBackPhoto', this)" style="font-size:12px; width:100%;">
                                <button class="btn btn-sm" style="background:var(--red); margin-top:8px; width:100%; padding:6px 10px;" onclick="deleteVesselPhoto('registrationBackPhoto')">Delete</button>
                            </div>
                        </div>
                                </div>
                            </div>
                <div class="collapsible" style="margin-bottom:15px;">
                    <div class="col-header crew-med-header" data-sidebar-id="crew-info" onclick="toggleSection(this)" style="background:#e8f7ef; border:1px solid #c8e8d6; justify-content:flex-start; align-items:center;">
                        <span class="dev-tag">dev:crew-info-shell</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Crew Information</span>
                        <div id="crew-sort-wrap" style="display:none; margin-left:auto;" onclick="event.stopPropagation();" onmousedown="event.stopPropagation();">
                            <select id="crew-sort" onchange="event.stopPropagation(); loadData()" onclick="event.stopPropagation();" onmousedown="event.stopPropagation();" style="padding:8px; font-size:13px;">
                                <option value="last">Sort: Last Name</option>
                                <option value="first">Sort: First Name</option>
                                <option value="birthdate-asc">Sort: Birthdate (Youngest First)</option>
                                <option value="birthdate-desc">Sort: Birthdate (Oldest First)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-body" style="padding:15px; background:#f7fffb; border:1px solid #c8e8d6; border-top:none;">
                        <div class="collapsible" style="margin-bottom:15px;">
                            <div class="col-header crew-med-header" data-sidebar-id="crew-add" onclick="toggleSection(this)" style="background:#f4fff6; justify-content:flex-start;">
                                <span class="dev-tag">dev:crew-add</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Add New Crew Member</span>
                            </div>
                            <div class="col-body" style="padding:15px; background:#f8f9fa;">
                                <div class="dev-tag" style="margin-bottom:6px;">dev:crew-add-fields</div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:15px;">
                                    <div><div class="dev-tag">dev:crew-add-first</div><label style="font-size:13px; margin-bottom:2px;">First Name *</label><input type="text" id="cn-first" style="padding:6px; width:100%;"></div>
                                    <div><div class="dev-tag">dev:crew-add-middle</div><label style="font-size:13px; margin-bottom:2px;">Middle Name(s)</label><input type="text" id="cn-middle" style="padding:6px; width:100%;"></div>
                                    <div><div class="dev-tag">dev:crew-add-last</div><label style="font-size:13px; margin-bottom:2px;">Last Name *</label><input type="text" id="cn-last" style="padding:6px; width:100%;"></div>
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:15px;">
                                    <div><div class="dev-tag">dev:crew-add-sex</div><label style="font-size:13px; margin-bottom:2px;">Sex</label><select id="cn-sex" style="padding:6px; width:100%;">
                                        <option value="">Select...</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Non-binary">Non-binary</option>
                                        <option value="Other">Other</option>
                                        <option value="Prefer not to say">Prefer not to say</option>
                                    </select></div>
                                    <div><div class="dev-tag">dev:crew-add-birthdate</div><label style="font-size:13px; margin-bottom:2px;">Birthdate</label><input type="date" id="cn-birthdate" style="padding:6px; width:100%;"></div>
                                    <div><div class="dev-tag">dev:crew-add-position</div><label style="font-size:13px; margin-bottom:2px;">Position</label><select id="cn-position" style="padding:6px; width:100%;">
                                        <option value="">Select...</option>
                                        <option value="Captain">Captain</option>
                                        <option value="Crew">Crew</option>
                                        <option value="Passenger">Passenger</option>
                                    </select></div>
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:15px;">
                                    <div><div class="dev-tag">dev:crew-add-citizenship</div><label style="font-size:13px; margin-bottom:2px;">Citizenship</label><input type="text" id="cn-citizenship" list="countries" style="padding:6px; width:100%;"></div>
                                    <div><div class="dev-tag">dev:crew-add-birthplace</div><label style="font-size:13px; margin-bottom:2px;">Birthplace</label><input type="text" id="cn-birthplace" list="countries" style="padding:6px; width:100%;"></div>
                                    <div><div class="dev-tag">dev:crew-add-passport</div><label style="font-size:13px; margin-bottom:2px;">Passport Number</label><input type="text" id="cn-passport" style="padding:6px; width:100%;"></div>
                                    <div><div class="dev-tag">dev:crew-add-pass-issue</div><label style="font-size:13px; margin-bottom:2px;">Issue Date</label><input type="date" id="cn-pass-issue" style="padding:6px; width:100%;"></div>
                                    <div><div class="dev-tag">dev:crew-add-pass-expiry</div><label style="font-size:13px; margin-bottom:2px;">Expiry Date</label><input type="date" id="cn-pass-expiry" style="padding:6px; width:100%;"></div>
                                </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:15px;">
                                <div><div class="dev-tag">dev:crew-add-phone</div><label style="font-size:13px; margin-bottom:2px;">Cell/WhatsApp</label><input type="text" id="cn-phone" placeholder="+1234567890" style="padding:6px; width:100%;"></div>
                                <div><div class="dev-tag">dev:crew-add-passport-photo</div><label style="font-size:13px; margin-bottom:2px;">Passport Head Shot Photo/PDF</label><input type="file" id="cn-passport-photo" accept="image/*,.pdf" style="padding:4px; width:100%; font-size:13px;"></div>
                                <div><div class="dev-tag">dev:crew-add-passport-page</div><label style="font-size:13px; margin-bottom:2px;">Passport Page Photo/PDF</label><input type="file" id="cn-passport-page" accept="image/*,.pdf" style="padding:4px; width:100%; font-size:13px;"></div>
                            </div>
                            <div style="margin-bottom:8px;"><label style="font-size:12px; font-weight:bold;">Emergency Contact</label></div>
                            <div class="dev-tag" style="margin-bottom:6px;">dev:crew-add-emergency</div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; margin-bottom:8px; font-size:15px;">
                                <div><div class="dev-tag">dev:crew-add-emerg-name</div><label style="font-size:13px; margin-bottom:2px;">Name</label><input type="text" id="cn-emerg-name" style="padding:6px; width:100%;"></div>
                                <div><div class="dev-tag">dev:crew-add-emerg-rel</div><label style="font-size:13px; margin-bottom:2px;">Relationship</label><input type="text" id="cn-emerg-rel" style="padding:6px; width:100%;"></div>
                                <div><div class="dev-tag">dev:crew-add-emerg-phone</div><label style="font-size:13px; margin-bottom:2px;">Phone</label><input type="text" id="cn-emerg-phone" style="padding:6px; width:100%;"></div>
                                <div><div class="dev-tag">dev:crew-add-emerg-email</div><label style="font-size:13px; margin-bottom:2px;">Email</label><input type="email" id="cn-emerg-email" style="padding:6px; width:100%;"></div>
                            </div>
                            <div style="margin-bottom:10px; font-size:15px;">
                                <label style="font-size:13px; margin-bottom:2px;">Emergency Contact Notes</label>
                                <div class="dev-tag">dev:crew-add-emerg-notes</div>
                                <input type="text" id="cn-emerg-notes" placeholder="Additional emergency contact information" style="padding:6px; width:100%;">
                            </div>
                            <datalist id="countries">
                                <option value="USA"><option value="Canada"><option value="UK"><option value="Australia"><option value="New Zealand"><option value="France"><option value="Germany"><option value="Spain"><option value="Italy"><option value="Netherlands"><option value="Singapore"><option value="Malaysia"><option value="Thailand"><option value="Philippines"><option value="Japan"><option value="China"><option value="India">
                            </datalist>
                            <button onclick="addCrew()" class="btn btn-sm" style="background:var(--dark); width:100%;"><span class="dev-tag">dev:crew-add-submit</span>Add Crew Member</button>
                        </div>
                        </div>

                        <div class="dev-tag" style="margin-bottom:6px;">dev:crew-info-anchor</div>
                        <div id="crew-info-list"></div>
                    </div>
                </div>
                </div>
            </div>
        </div>
        <div class="page-sidebar" data-tab="VesselCrewInfo" onclick="toggleSidebar(this)">
            <button class="sidebar-toggle">Context ‚Üí</button>
            <div class="sidebar-content">
                {% include 'sidebars/sidebar_vessel.html' %}
            </div>
        </div>
    </div>
</div>
</div>
<div id="Settings" class="content">
    <div class="page-shell">
            <div class="page-body sidebar-open">
            <div class="page-main">
                <div class="panel-wrapper">
                    <div class="collapsible" style="margin-bottom:12px;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-crew-creds</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Crew Login Credentials</span>
                            <span id="crew-creds-meta" style="margin-left:auto; font-size:12px; color:#4a5568;"></span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa;">
                            <div id="crew-credentials"></div>
                        </div>
                    </div>
                    <div class="collapsible" style="margin-bottom:12px;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-vax-types</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Vaccine Type Dropdown</span>
                            <span id="vax-meta" style="margin-left:auto; font-size:12px; color:#4a5568;"></span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa; display:none;">
                            <div style="margin-bottom:8px; font-size:12px; color:#2c3e50;">Manage the Vaccine Type/Disease options shown in Crew Vaccines. An "Other" option is always available for ad-hoc entries.</div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
                                <input id="vaccine-type-input" type="text" style="padding:8px; min-width:220px; flex:1;" placeholder="e.g., MMR, DTaP, HepB">
                                <button class="btn btn-sm" style="background:var(--inquiry);" onclick="addVaccineType()">Add Type</button>
                            </div>
                            <div class="dev-tag" style="margin-bottom:6px;">dev:settings-vax-list</div>
                            <div id="vaccine-types-list"></div>
                            <div id="vaccine-types-status" style="margin-top:8px; font-size:12px; color:#555;">Saved with app settings.</div>
                        </div>
                    </div>
                    <div class="collapsible" style="margin-bottom:12px;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-pharmacy-labels</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Pharmaceutical User Labels</span>
                            <span id="pharm-meta" style="margin-left:auto; font-size:12px; color:#4a5568;"></span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa; display:none;">
                            <div style="margin-bottom:8px; font-size:12px; color:#2c3e50;">Define the User Labels used on Pharmaceuticals. These power the dropdown next to Verified in the Medical Chest.</div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
                                <input id="pharmacy-label-input" type="text" style="padding:8px; min-width:220px; flex:1;" placeholder="e.g., Analgesic, Cardiac, Emergency">
                                <button class="btn btn-sm" style="background:var(--inquiry);" onclick="addPharmacyLabel()">Add Label</button>
                            </div>
                            <div class="dev-tag" style="margin-bottom:6px;">dev:settings-pharmacy-label-list</div>
                            <div id="pharmacy-labels-list"></div>
                            <div id="pharmacy-labels-status" style="margin-top:8px; font-size:12px; color:#555;">Saved with app settings.</div>
                        </div>
                    </div>
                    <div class="collapsible" style="margin-bottom:12px;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-usermode</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">User Mode</span>
                            <span id="user-mode-meta" style="margin-left:auto; font-size:12px; color:#4a5568;"></span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa;">
                            <label for="user_mode">User Mode</label>
                            <select id="user_mode" style="padding:10px; min-width:200px;">
                                <option value="user">User</option>
                                <option value="advanced">Advanced</option>
                                <option value="developer">Developer</option>
                            </select>
                            <div style="margin-top:10px;">
                                <a class="btn btn-sm" style="background:#b23b00; display:inline-block;" href="/logout?fresh=1" onclick="if (typeof forceClearCache === 'function') { forceClearCache(); return false; }"><span class="dev-tag">dev:cache-bust</span>Force Reload</a>
                            </div>
                            <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#333; margin-top:10px;">
                                <input type="checkbox" id="db_write_lock" />
                                Database Write Lock (read-only mode)
                            </label>
                            <div id="db-write-lock-forced-note" style="margin-top:6px; font-size:12px; color:#b23b00; display:none;">
                                Write lock is forced by environment variable <code>DB_WRITE_LOCK</code>.
                            </div>
                            <div style="margin-top:8px; font-size:12px; color:#555;">
                                User: hides advanced controls. Advanced: shows prompt tools. Developer: also shows dev tags.
                            </div>
                        </div>
                    </div>
                    <div class="collapsible" style="margin-bottom:12px;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-offline</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Offline Readiness Check</span>
                            <span id="offline-meta" style="margin-left:auto; font-size:12px; color:#4a5568;"></span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa;">
                            <div style="font-size:12px; color:#475569; margin-bottom:8px;">
                                Run this check before departure to confirm all required models and cache files are available without internet.
                            </div>
                            <div id="offline-status" style="font-size:13px; color:#2c3e50; margin-bottom:10px; min-height:40px;">Not checked yet.</div>
                            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
                                <button id="offline-check-btn" class="btn btn-sm" style="background:var(--inquiry);" onclick="runOfflineCheck(false)">Run readiness check</button>
                                <button id="offline-download-btn" class="btn btn-sm" style="background:#1f2d3d;" onclick="runOfflineCheck(true)">Download missing models</button>
                                <button id="offline-backup-btn" class="btn btn-sm" style="background:#00695c;" onclick="createOfflineBackup()">Create backup snapshot</button>
                                <button id="offline-restore-btn" class="btn btn-sm" style="background:#8e44ad;" onclick="restoreOfflineBackup()">Restore latest backup</button>
                                <button id="offline-flag-btn" class="btn btn-sm" style="background:#b26a00;" onclick="toggleOfflineFlags()">Enable offline mode</button>
                            </div>
                            <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#333; margin-bottom:6px;">
                                <input type="checkbox" id="offline-force-flags" onclick="toggleOfflineFlags(this.checked)" />
                                Persist offline mode in settings (recommended before going offshore)
                            </label>
                            <div style="font-size:12px; color:#555;">Recommended sequence: Run readiness check ‚Üí Download missing models ‚Üí Create backup snapshot ‚Üí Enable offline mode.</div>
                        </div>
                    </div>
                    <div class="collapsible" style="margin-bottom:12px;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-runtime-log</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Runtime Debug Log (HF)</span>
                            <span id="runtime-log-meta" style="margin-left:auto; font-size:12px; color:#4a5568;"></span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa; display:none;">
                            <div style="font-size:12px; color:#475569; margin-bottom:8px;">
                                Use this log to troubleshoot stalled or failed MedGemma requests on Hugging Face.
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;">
                                <label for="runtime-log-lines" style="font-size:12px; color:#333;">Lines</label>
                                <input id="runtime-log-lines" data-settings-no-autosave="1" type="number" min="50" max="5000" step="50" value="600" style="width:90px; padding:6px;">
                                <button class="btn btn-sm" style="background:var(--inquiry);" onclick="loadRuntimeLog()">Refresh</button>
                                <button class="btn btn-sm" style="background:#0b8457;" onclick="downloadRuntimeLog()">Download</button>
                                <button class="btn btn-sm" style="background:#8b0000;" onclick="clearRuntimeLog()">Clear</button>
                            </div>
                            <div id="runtime-log-status" style="font-size:12px; color:#2c3e50; margin-bottom:8px;">Not loaded yet.</div>
                            <textarea id="runtime-log-text" data-settings-no-autosave="1" readonly style="width:100%; min-height:240px; font-family:Menlo, Consolas, monospace; font-size:12px; line-height:1.35; background:#fff;"></textarea>
                        </div>
                    </div>
                    <div class="collapsible" style="margin-bottom:12px;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-last-prompt</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Last Prompt Verbatim</span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa; display:none;">
                            <div style="margin-bottom:8px; font-size:12px; color:#2c3e50;">Shows the exact prompt submitted to MedGemma for the most recent chat.</div>
                            <textarea id="last_prompt_verbatim" readonly style="width:100%; min-height:160px;"></textarea>
                        </div>
                    </div>
                    <div class="collapsible developer-only" style="margin-bottom:12px; display:none;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-default-export</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Export Default Dataset (Dev)</span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa;">
                            <div style="margin-bottom:8px; font-size:12px; color:#555;">Exports the current data as default JSON files into <code>data/default/</code>.</div>
                            <button class="btn btn-sm" style="background:#0b8457;" onclick="exportDefaultDataset()">Export JSON Defaults</button>
                            <div id="default-export-status" style="margin-top:8px; font-size:12px; color:#555;"></div>
                        </div>
                    </div>
                    <div class="collapsible" style="margin-top:12px;">
                        <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                            <span class="dev-tag">dev:settings-models</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">MedGemma Model Parameters</span>
                            <span id="model-meta" style="margin-left:auto; font-size:12px; color:#4a5568;"></span>
                        </div>
                        <div class="col-body" style="padding:12px; background:#f8f9fa; display:flex; flex-direction:column;">
                            <div class="collapsible" style="margin-bottom:12px; order:3;">
                                <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                                    <span class="dev-tag">dev:settings-triage</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Triage Mode General</span>
                                </div>
                                <div class="col-body" style="padding:12px; background:#f8f9fa;">
                                    <label>Instruction Text Block</label>
                                    <textarea id="triage_instruction" style="height:120px;"></textarea>
                                    <div style="margin-top:10px; padding:10px; border:1px solid #dde3ec; border-radius:8px; background:#fff;">
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <input id="triage_prompt_template_name" data-settings-no-autosave="1" type="text" style="padding:8px; min-width:220px; flex:1;" placeholder="Prompt name (e.g., Triage v2)">
                                            <button class="btn btn-sm" style="background:#0b8457;" onclick="savePromptTemplate('triage_instruction')">Save Prompt Version</button>
                                        </div>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
                                            <select id="triage_prompt_template_select" data-settings-no-autosave="1" style="padding:8px; min-width:220px; flex:1;">
                                                <option value="">Select saved triage prompt‚Ä¶</option>
                                            </select>
                                            <button class="btn btn-sm" style="background:var(--inquiry);" onclick="loadSelectedPromptTemplate('triage_instruction')">Load Selected Prompt</button>
                                        </div>
                                        <div id="triage_prompt_template_status" style="margin-top:6px; font-size:12px; color:#4a5568;"></div>
                                    </div>
                                    <div style="display:flex; gap:20px; margin-top:15px; align-items:center;">
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span title="Temperature: higher = more random, lower = more deterministic." style="font-weight:700;">Temp:</span>
                                            <input type="number" id="tr_temp" step="0.1" style="width:60px;">
                                        </div>
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span title="Max new tokens the model can generate in the response." style="font-weight:700;">Tokens:</span>
                                            <input type="number" id="tr_tok" style="width:80px;">
                                        </div>
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span title="Top-P (nucleus sampling): lower = safer, higher = more diverse." style="font-weight:700;">Top-P:</span>
                                            <input type="number" id="tr_p" step="0.05" style="width:60px;">
                                        </div>
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span title="Top-K sampling: limits token choices to the K most likely options each step." style="font-weight:700;">Top-K:</span>
                                            <input type="number" id="tr_k" style="width:60px;">
                                        </div>
                                        <div style="margin-left:auto;">
                                            <button class="btn btn-sm" style="background:var(--inquiry);" onclick="resetSection('triage')">Reset to Default</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible" style="margin-bottom:12px; order:2;">
                                <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                                    <span class="dev-tag">dev:settings-inquiry</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Inquiry Mode</span>
                                </div>
                                <div class="col-body" style="padding:12px; background:#f8f9fa;">
                                    <label>Instruction Text Block</label>
                                    <textarea id="inquiry_instruction" style="height:120px;"></textarea>
                                    <div style="margin-top:10px; padding:10px; border:1px solid #dde3ec; border-radius:8px; background:#fff;">
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <input id="inquiry_prompt_template_name" data-settings-no-autosave="1" type="text" style="padding:8px; min-width:220px; flex:1;" placeholder="Prompt name (e.g., Inquiry concise)">
                                            <button class="btn btn-sm" style="background:#0b8457;" onclick="savePromptTemplate('inquiry_instruction')">Save Prompt Version</button>
                                        </div>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
                                            <select id="inquiry_prompt_template_select" data-settings-no-autosave="1" style="padding:8px; min-width:220px; flex:1;">
                                                <option value="">Select saved inquiry prompt‚Ä¶</option>
                                            </select>
                                            <button class="btn btn-sm" style="background:var(--inquiry);" onclick="loadSelectedPromptTemplate('inquiry_instruction')">Load Selected Prompt</button>
                                        </div>
                                        <div id="inquiry_prompt_template_status" style="margin-top:6px; font-size:12px; color:#4a5568;"></div>
                                    </div>
                                    <div style="display:flex; gap:20px; margin-top:15px; align-items:center;">
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span title="Temperature: higher = more creative, lower = more factual." style="font-weight:700;">Temp:</span>
                                            <input type="number" id="in_temp" step="0.1" style="width:60px;">
                                        </div>
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span title="Max new tokens the model can generate in the response." style="font-weight:700;">Tokens:</span>
                                            <input type="number" id="in_tok" style="width:80px;">
                                        </div>
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span title="Top-P (nucleus sampling): lower = safer, higher = more diverse." style="font-weight:700;">Top-P:</span>
                                            <input type="number" id="in_p" step="0.05" style="width:60px;">
                                        </div>
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span title="Top-K sampling: limits token choices to the K most likely options each step." style="font-weight:700;">Top-K:</span>
                                            <input type="number" id="in_k" style="width:60px;">
                                        </div>
                                        <div style="margin-left:auto;">
                                            <button class="btn btn-sm" style="background:var(--inquiry);" onclick="resetSection('inquiry')">Reset to Default</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible" style="margin-bottom:12px; order:4;">
                                <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                                    <span class="dev-tag">dev:settings-triage-tree</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Triage Mode Clinical Triage Pathway Prompt Builder</span>
                                    <span style="margin-left:auto; display:flex; gap:6px;" onclick="event.stopPropagation();">
                                        <button class="btn btn-sm" style="background:#0b8457;" onclick="event.stopPropagation(); exportTriagePromptTreeJson();">Export</button>
                                        <button class="btn btn-sm" style="background:#0f766e;" onclick="event.stopPropagation(); triggerTriagePromptTreeImportPicker();">Import</button>
                                        <button class="btn btn-sm" style="background:#4a5568;" onclick="event.stopPropagation(); resetTriagePromptTreeToDefault();">Reset to Default</button>
                                    </span>
                                </div>
                                <div class="col-body" style="padding:12px; background:#f8f9fa;">
                                    <input id="triage-tree-import-file" data-settings-no-autosave="1" type="file" accept="application/json,.json" style="display:none;" onchange="importTriagePromptTreeJson(event)">
                                    <div style="margin-bottom:8px; font-size:12px; color:#2c3e50;">
                                        Edit the hierarchical rule tree used for triage path assembly. The model receives only the selected branch plus user metadata.
                                    </div>
                                    <label for="triage-tree-base-doctrine" style="font-size:12px; color:#333; font-weight:700;">Base Doctrine</label>
                                    <div id="triage-tree-base-path" style="margin:4px 0 6px; font-size:11px; color:#4a5568;">Path: Global (all triage paths)</div>
                                    <textarea id="triage-tree-base-doctrine" data-settings-no-autosave="1" style="min-height:90px; width:100%;" placeholder="Base doctrine text..."></textarea>
                                    <div style="margin-top:8px; font-size:12px; color:#2c3e50;">
                                        Decision path levels: <strong>1) Domain</strong> ‚Üí <strong>2) Problem</strong> ‚Üí <strong>3) Anatomy</strong> ‚Üí <strong>4) Mechanism / Cause</strong> ‚Üí <strong>5) Severity / Complication</strong>
                                    </div>
                                    <div style="margin-top:10px; padding:10px; border:1px solid #dde3ec; border-radius:8px; background:#fff;">
                                        <div style="font-size:12px; color:#1f3b57; font-weight:800; margin-bottom:6px;">1) Domain</div>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <label for="triage-tree-domain-select" style="font-size:12px; color:#333; font-weight:700; min-width:90px;">Domain</label>
                                            <select id="triage-tree-domain-select" data-settings-no-autosave="1" style="padding:8px; min-width:220px; flex:1;"></select>
                                            <input id="triage-tree-domain-new" data-settings-no-autosave="1" type="text" style="padding:8px; min-width:220px; flex:1;" placeholder="New domain name">
                                            <button class="btn btn-sm" style="background:#0b8457;" onclick="addTriageTreeDomain()">Add Domain</button>
                                            <button class="btn btn-sm" style="background:var(--red);" onclick="deleteTriageTreeDomain()">Delete Domain</button>
                                        </div>
                                        <div style="margin-top:8px;">
                                            <label for="triage-tree-domain-mindset" style="font-size:12px; color:#333; font-weight:700;">Domain Mindset</label>
                                            <div id="triage-tree-domain-path" style="margin:4px 0 6px; font-size:11px; color:#4a5568;">Path: (select Domain)</div>
                                            <textarea id="triage-tree-domain-mindset" data-settings-no-autosave="1" style="min-height:70px; width:100%;" placeholder="Mindset text for selected domain..."></textarea>
                                        </div>
                                    </div>
                                    <div style="margin-top:10px; padding:10px; border:1px solid #dde3ec; border-radius:8px; background:#fff;">
                                        <div style="font-size:12px; color:#1f3b57; font-weight:800; margin-bottom:6px;">2) Problem</div>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <label for="triage-tree-problem-select" style="font-size:12px; color:#333; font-weight:700; min-width:90px;">Problem</label>
                                            <select id="triage-tree-problem-select" data-settings-no-autosave="1" style="padding:8px; min-width:240px; flex:1;"></select>
                                            <input id="triage-tree-problem-new" data-settings-no-autosave="1" type="text" style="padding:8px; min-width:240px; flex:1;" placeholder="New problem name">
                                            <button class="btn btn-sm" style="background:#0b8457;" onclick="addTriageTreeProblem()">Add Problem</button>
                                            <button class="btn btn-sm" style="background:var(--red);" onclick="deleteTriageTreeProblem()">Delete Problem</button>
                                        </div>
                                        <div style="margin-top:8px;">
                                            <label for="triage-tree-procedure" style="font-size:12px; color:#333; font-weight:700;">Procedure</label>
                                            <div id="triage-tree-procedure-path" style="margin:4px 0 6px; font-size:11px; color:#4a5568;">Path: (select Domain and Problem)</div>
                                            <textarea id="triage-tree-procedure" data-settings-no-autosave="1" style="min-height:80px; width:100%;" placeholder="Procedure for selected problem..."></textarea>
                                        </div>
                                    </div>
                                    <div style="margin-top:10px; padding:10px; border:1px solid #dde3ec; border-radius:8px; background:#fff;">
                                        <div style="font-size:12px; color:#1f3b57; font-weight:800; margin-bottom:6px;">3) Anatomy</div>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <select id="triage-tree-anatomy-key-select" data-settings-no-autosave="1" style="padding:8px; min-width:240px; flex:1;"></select>
                                            <input id="triage-tree-anatomy-key-new" data-settings-no-autosave="1" type="text" style="padding:8px; min-width:240px; flex:1;" placeholder="New anatomy option name">
                                            <button class="btn btn-sm" style="background:#0b8457;" onclick="addTriageTreeAnatomyOption()">Add Option</button>
                                            <button class="btn btn-sm" style="background:var(--red);" onclick="deleteTriageTreeAnatomyOption()">Delete Option</button>
                                        </div>
                                        <div style="margin-top:8px;">
                                            <label for="triage-tree-anatomy-text" style="font-size:12px; color:#333; font-weight:700;">Anatomy Rule Text</label>
                                            <div id="triage-tree-anatomy-path" style="margin:4px 0 6px; font-size:11px; color:#4a5568;">Path: (select Domain, Problem, and Anatomy)</div>
                                            <textarea id="triage-tree-anatomy-text" data-settings-no-autosave="1" style="min-height:90px; width:100%;" placeholder="Rule text for selected anatomy option..."></textarea>
                                        </div>
                                    </div>
                                    <div style="margin-top:10px; padding:10px; border:1px solid #dde3ec; border-radius:8px; background:#fff;">
                                        <div style="font-size:12px; color:#1f3b57; font-weight:800; margin-bottom:6px;">4) Mechanism / Cause</div>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <select id="triage-tree-severity-key-select" data-settings-no-autosave="1" style="padding:8px; min-width:240px; flex:1;"></select>
                                            <input id="triage-tree-severity-key-new" data-settings-no-autosave="1" type="text" style="padding:8px; min-width:240px; flex:1;" placeholder="New mechanism option name">
                                            <button class="btn btn-sm" style="background:#0b8457;" onclick="addTriageTreeSeverityOption()">Add Option</button>
                                            <button class="btn btn-sm" style="background:var(--red);" onclick="deleteTriageTreeSeverityOption()">Delete Option</button>
                                        </div>
                                        <div style="margin-top:8px;">
                                            <label for="triage-tree-severity-text" style="font-size:12px; color:#333; font-weight:700;">Mechanism Rule Text</label>
                                            <div id="triage-tree-severity-path" style="margin:4px 0 6px; font-size:11px; color:#4a5568;">Path: (select Domain, Problem, Anatomy, and Mechanism)</div>
                                            <textarea id="triage-tree-severity-text" data-settings-no-autosave="1" style="min-height:90px; width:100%;" placeholder="Rule text for selected mechanism option..."></textarea>
                                        </div>
                                    </div>
                                    <div style="margin-top:10px; padding:10px; border:1px solid #dde3ec; border-radius:8px; background:#fff;">
                                        <div style="font-size:12px; color:#1f3b57; font-weight:800; margin-bottom:6px;">5) Severity / Complication</div>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <select id="triage-tree-mechanism-key-select" data-settings-no-autosave="1" style="padding:8px; min-width:240px; flex:1;"></select>
                                            <input id="triage-tree-mechanism-key-new" data-settings-no-autosave="1" type="text" style="padding:8px; min-width:240px; flex:1;" placeholder="New severity option name">
                                            <button class="btn btn-sm" style="background:#0b8457;" onclick="addTriageTreeMechanismOption()">Add Option</button>
                                            <button class="btn btn-sm" style="background:var(--red);" onclick="deleteTriageTreeMechanismOption()">Delete Option</button>
                                        </div>
                                        <div style="margin-top:8px;">
                                            <label for="triage-tree-mechanism-text" style="font-size:12px; color:#333; font-weight:700;">Severity Rule Text</label>
                                            <div id="triage-tree-mechanism-path" style="margin:4px 0 6px; font-size:11px; color:#4a5568;">Path: (select Domain, Problem, Anatomy, Mechanism, and Severity)</div>
                                            <textarea id="triage-tree-mechanism-text" data-settings-no-autosave="1" style="min-height:90px; width:100%;" placeholder="Rule text for selected severity option..."></textarea>
                                        </div>
                                    </div>
                                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                                        <button class="btn btn-sm" style="background:#4a5568;" onclick="loadTriagePromptTree()">Reload from Database</button>
                                    </div>
                                    <div id="triage-tree-status" style="margin-top:8px; font-size:12px; color:#4a5568;"></div>
                                </div>
                            </div>
                            <div class="collapsible" style="margin-bottom:12px; order:1;">
                                <div class="col-header crew-med-header" onclick="toggleSection(this)" style="background:#fff; justify-content:flex-start;">
                                    <span class="dev-tag">dev:settings-mission</span><span class="detail-icon history-arrow" style="font-size:18px; margin-right:8px;">‚ñ∏</span><span style="font-weight:700;">Mission Context</span>
                                </div>
                                <div class="col-body" style="padding:12px; background:#f8f9fa;">
                                    <textarea id="mission_context" style="height:60px;"></textarea>
                                    <div style="margin-top:12px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                                        <button class="btn btn-sm" style="background:var(--inquiry);" onclick="resetSection('mission')">Reset to Default</button>
                                        <div id="settings-save-status" style="font-size:12px; color:#2c3e50; min-height:18px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page-sidebar" data-tab="Settings" onclick="toggleSidebar(this)">
                <button class="sidebar-toggle">Context ‚Üí</button>
                <div class="sidebar-content">
                    {% include 'sidebars/sidebar_settings.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

</div>
<!-- DB missing modal -->
<div id="db-modal" style="display:none; position:fixed; inset:0; z-index:2000; background:rgba(6,28,48,0.55); align-items:center; justify-content:center; padding:20px;">
    <div style="background:#ffffff; border-radius:16px; box-shadow:0 18px 48px rgba(0,0,0,0.25); max-width:520px; width:100%; padding:22px; border:1px solid #d8e2f5;">
        <div style="font-size:13px; font-weight:800; color:#0c6cc4; margin-bottom:6px;">Database Required</div>
        <div style="font-size:22px; font-weight:800; color:#122b4d; margin-bottom:10px;">Load an existing app.db or start fresh</div>
        <div style="font-size:14px; color:#3c4a60; margin-bottom:14px;">We couldn‚Äôt find a database file. Upload your existing <code>app.db</code> or create a new one to continue.</div>
        <div id="db-modal-status" style="font-size:13px; color:#c62828; margin-bottom:10px; display:none;"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
            <button class="btn" style="background:#1250a5; color:#fff;" onclick="document.getElementById('db-upload-input').click()">Upload app.db</button>
            <input id="db-upload-input" type="file" accept=".db" style="display:none;" onchange="uploadDbFile(event)">
            <button class="btn" style="background:#2e7d32; color:#fff;" onclick="createNewDb()">Create new database</button>
        </div>
        <div style="font-size:12px; color:#5b6675;">Uploaded files replace the current database. Creating new will seed the default dataset.</div>
    </div>
</div>

    <div id="chat-blocker">
        <div class="modal">
            <div class="spinner"></div>
            <h3>Processing Triage Consultation‚Ä¶</h3>
        <p id="chat-model-line" style="margin:6px 0; font-weight:700; color:#122b4d;">Model: ‚Ä¶</p>
        <p id="chat-eta-line" style="margin:0 0 8px 0; color:#2c3e50;">Expected duration: calculating‚Ä¶</p>
        <p>Please wait. Navigation or edits in SailingMedAdvisor<br>are temporarily paused until this response completes.</p>
        </div>
    </div>

    <script>
        // Preload vessel data from server-rendered context to avoid empty fields if API fetch is delayed or fails
        window.VESSEL_PREFILL = {{ vessel_prefill|tojson|safe }};
    </script>
    <script src="/static/js/utils.js?v=20260226"></script>
    <script src="/static/js/chat.js?v=20260315"></script>
    <script src="/static/js/crew.js?v=20260223"></script>
    <script src="/static/js/pharmacy.js?v=20260223"></script>
    <script src="/static/js/equipment.js?v=20260223"></script>
    <script src="/static/js/settings.js?v=20260308"></script>
    <script src="/static/js/main.js?v=20260223"></script>
    <script src="/static/js/recovery.js?v=20260304"></script>
<script>
    function showDbModal(message) {
        const modal = document.getElementById('db-modal');
        if (message) {
            const status = document.getElementById('db-modal-status');
            status.textContent = message;
            status.style.display = 'block';
        }
        modal.style.display = 'flex';
    }

    async function checkDbStatus() {
        try {
            const res = await fetch('/api/db/status', { credentials: 'same-origin' });
            if (!res.ok) throw new Error(`Status ${res.status}`);
            const data = await res.json();
            if (!data.exists) {
                showDbModal();
            }
        } catch (err) {
            console.warn('DB status check failed', err);
        }
    }

    async function uploadDbFile(evt) {
        const file = evt.target.files && evt.target.files[0];
        if (!file) return;
        const status = document.getElementById('db-modal-status');
        status.style.display = 'block';
        status.style.color = '#1250a5';
        status.textContent = 'Uploading database...';
        const fd = new FormData();
        fd.append('file', file, file.name || 'app.db');
        try {
            const res = await fetch('/api/db/upload', { method: 'POST', body: fd, credentials: 'same-origin' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) throw new Error(data.error || `Status ${res.status}`);
            status.style.color = '#2e7d32';
            status.textContent = 'Upload complete. Reloading...';
            setTimeout(() => window.location.reload(), 600);
        } catch (err) {
            status.style.color = '#c62828';
            status.textContent = `Upload failed: ${err.message}`;
        }
    }

    async function createNewDb() {
        const status = document.getElementById('db-modal-status');
        status.style.display = 'block';
        status.style.color = '#1250a5';
        status.textContent = 'Creating new database...';
        try {
            const res = await fetch('/api/db/create', { method: 'POST', credentials: 'same-origin' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) throw new Error(data.error || `Status ${res.status}`);
            status.style.color = '#2e7d32';
            status.textContent = 'Database created. Reloading...';
            setTimeout(() => window.location.reload(), 600);
        } catch (err) {
            status.style.color = '#c62828';
            status.textContent = `Create failed: ${err.message}`;
        }
    }

    document.addEventListener('DOMContentLoaded', checkDbStatus);
</script>
</body>
</html>
